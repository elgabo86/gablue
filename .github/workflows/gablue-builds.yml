name: build-gablue-images
on:
  pull_request:
    branches:
      - main
  schedule:
    - cron: "00 06 * * *"
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  build-main:
    name: Build main
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'push' && (contains(github.event.head_commit.message, '[main]') || contains(github.event.head_commit.message, '[all]')))
    uses: ./.github/workflows/reusable-gablue-image.yml
    with:
      image_name: "gablue-main"
      image_desc: "Gablue main image"
      image_variant: "main"
      source_image: "kinoite"
      source_suffix: "-main"
      fedora_version: "43"
      kernel_type: "bazzite"
      kernel_version: ""

  build-nvidia:
    name: Build nvidia
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'push' && (contains(github.event.head_commit.message, '[nvidia]') || contains(github.event.head_commit.message, '[all]')))
    uses: ./.github/workflows/reusable-gablue-image.yml
    with:
      image_name: "gablue-nvidia"
      image_desc: "Gablue nvidia image"
      image_variant: "nvidia"
      source_image: "kinoite"
      source_suffix: "-main"
      fedora_version: "43"
      kernel_type: "bazzite"
      kernel_version: ""

  build-nvidia-open:
    name: Build nvidia-open
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'push' && (contains(github.event.head_commit.message, '[nvidia]') || contains(github.event.head_commit.message, '[all]')))
    uses: ./.github/workflows/reusable-gablue-image.yml
    with:
      image_name: "gablue-nvidia-open"
      image_desc: "Gablue nvidia-open image"
      image_variant: "nvidia-open"
      source_image: "kinoite"
      source_suffix: "-main"
      fedora_version: "43"
      kernel_type: "bazzite"
      kernel_version: ""

  build-dx:
    name: Build DX
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'push' && (contains(github.event.head_commit.message, '[dx]') || contains(github.event.head_commit.message, '[all]')))
    uses: ./.github/workflows/reusable-gablue-image.yml
    with:
      image_name: "gablue-main-dx"
      image_desc: "Gablue main-dx image (d√©veloppement avec virtualisation)"
      image_variant: "main"
      source_image: "kinoite"
      source_suffix: "-main"
      fedora_version: "43"
      kernel_type: "bazzite"
      kernel_version: ""

  build-test:
    name: Build test
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'push' && (contains(github.event.head_commit.message, '[test]') || contains(github.event.head_commit.message, '[all]')))
    uses: ./.github/workflows/reusable-gablue-image.yml
    with:
      image_name: "gablue-main-test"
      image_desc: "Gablue main test image"
      image_variant: "main"
      source_image: "kinoite"
      source_suffix: "-main"
      fedora_version: "43"
      kernel_type: "bazzite"
      kernel_version: ""

