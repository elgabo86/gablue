#!/usr/bin/bash

set -ouex pipefail

echo "::group::Executing install-nvidia"
trap 'echo "::group::"' EXIT

if [[ "${SOURCE_IMAGE}" == "kinoite" ]]; then
 VARIANT_PKGS="supergfxctl-plasmoid supergfxctl"
elif [[ "${SOURCE_IMAGE}" == "silverblue" ]]; then
 VARIANT_PKGS="gnome-shell-extension-supergfxctl-gex supergfxctl"
else
 VARIANT_PKGS=""
fi

dnf5 -y copr enable ublue-os/staging && \

dnf5 install -y \
    /rpms/nvidia/libnvidia-cfg-* \
    /rpms/nvidia/libnvidia-fbc-* \
    /rpms/nvidia/libnvidia-gpucomp-* \
    /rpms/nvidia/libnvidia-ml-* \
    /rpms/nvidia/nvidia-libXNVCtrl-5* \
    /rpms/nvidia/nvidia-settings-5* \
    /rpms/nvidia/nvidia-driver-* \
    /rpms/nvidia/nvidia-kmod-common-* \
    /rpms/nvidia/nvidia-modprobe-5* \
    /rpms/nvidia/nvidia-persistenced-5* \
    /rpms/nvidia/xorg-x11* \
    /rpms/nvidia/nvidia-container-toolkit-1* \
    /rpms/nvidia/nvidia-container-toolkit-base-1* \
    /rpms/nvidia/libnvidia-container1-1* \
    /rpms/nvidia/libnvidia-container-tools-1* \
    libva-nvidia-driver \
    ${VARIANT_PKGS}

dnf5 -y copr disable ublue-os/staging && \

systemctl enable ublue-nvctk-cdi.service
semodule --verbose --install /usr/share/selinux/packages/nvidia-container.pp

# Universal Blue specific Initramfs fixes
cp /etc/modprobe.d/nvidia-modeset.conf /usr/lib/modprobe.d/nvidia-modeset.conf
# we must force driver load to fix black screen on boot for nvidia desktops
sed -i 's@omit_drivers@force_drivers@g' /usr/lib/dracut/dracut.conf.d/99-nvidia.conf
# as we need forced load, also must pre-load intel/amd iGPU else chromium web browsers fail to use hardware acceleration
sed -i 's@ nvidia @ i915 amdgpu nvidia @g' /usr/lib/dracut/dracut.conf.d/99-nvidia.conf
