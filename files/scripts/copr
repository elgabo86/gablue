#!/usr/bin/bash

set -eoux pipefail

#Fix gpg error on dnf5 install
mkdir -p /var/roothome && \

# Configure repository exclusions for fedora and rpmfusion (terra will be configured after installation)
dnf5 -y config-manager setopt "*fedora*".exclude="mesa-* kernel-core-* kernel-modules-* kernel-uki-virt-*"
dnf5 -y config-manager setopt "*rpmfusion*".exclude="mesa-*"

for copr in \
        bazzite-org/bazzite \
        ublue-os/staging \
        ublue-os/packages \
        che/nerd-fonts \
        hikariknight/looking-glass-kvmfr \
        lizardbyte/beta; \
do \
        dnf5 -y copr enable $copr; \
done && unset -v copr && \

dnf5 -y config-manager addrepo --overwrite --from-repofile=https://pkgs.tailscale.com/stable/fedora/tailscale.repo && \

dnf5 -y config-manager addrepo --from-repofile=https://negativo17.org/repos/fedora-rar.repo && \

dnf5 -y install \
        https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm \
        https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm && \

# Installation Terra pour Mesa plus r√©cent (TOUTES les variantes l'ont maintenant)
dnf5 -y install --nogpgcheck --repofrompath 'terra,https://repos.fyralabs.com/terra$releasever' terra-release terra-release-extras && \

# Activer le stream Mesa de Terra et terra-nvidia pour les variants NVIDIA
dnf5 -y config-manager setopt terra-mesa.enabled=1
if [ "$VARIANT" == "nvidia" ] || [ "$VARIANT" == "nvidia-open" ]; then
    dnf5 -y config-manager setopt terra-nvidia.enabled=1
fi

# Configure terra repository exclusions (now available after terra installation)
dnf5 -y config-manager setopt "*terra*".priority=3 "*terra*".exclude="nerd-fonts topgrade scx-scheds steam python3-protobuf"

sed -i 's@enabled=0@enabled=1@g' /etc/yum.repos.d/negativo17-fedora-multimedia.repo
