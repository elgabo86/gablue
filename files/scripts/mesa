#!/usr/bin/bash

set -eoux pipefail

# Installation Mesa Terra en suivant le pattern Bazzite
# Le swap de mesa-filesystem tire automatiquement tous les autres packages Mesa depuis terra-mesa

# Swap Mesa filesystem avec la version Terra
dnf5 -y swap --repo=terra-mesa mesa-filesystem mesa-filesystem

# Installer les paquets Mesa principaux sans conflit
dnf5 -y install --repo=terra-mesa \
    mesa-dri-drivers \
    mesa-libEGL \
    mesa-libGL \
    mesa-libgbm \
    mesa-va-drivers \
    mesa-vulkan-drivers

# Ajouter les paquets i686 SEULEMENT pour les variants NVIDIA (compatibilité jeux)
if [ "$VARIANT" == "nvidia" ] || [ "$VARIANT" == "nvidia-open" ]; then
    dnf5 -y install --repo=terra-mesa \
        mesa-va-drivers.i686
fi

# Verrouiller les versions Mesa pour éviter les downgrades
dnf5 versionlock add \
    mesa-dri-drivers \
    mesa-filesystem \
    mesa-libEGL \
    mesa-libGL \
    mesa-libgbm \
    mesa-va-drivers \
    mesa-vulkan-drivers
