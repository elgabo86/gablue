<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="img-src 'self' data:;">
    <title>Générateur d'images IA</title>
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" as="style"
        onload="this.rel='stylesheet'">
    <style>
        :root {
            --primary: #7c3aed;
            --primary-dark: #6d28d9;
            --secondary: #22d3ee;
            --dark: #1f2937;
            --light: #e5e7eb;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --background: #111827;
            --card-background: #1f2937;
            --text: #d1d5db;
            --text-muted: #9ca3af;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--light);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .app-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            background: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .controls {
            padding: 1.5rem;
            background: var(--card-background);
        }

        .image-preview {
            padding: 1.5rem;
            background: var(--dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 500px;
            position: relative;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text);
            font-size: 0.95rem;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 0.7rem;
            border: 1px solid var(--text-muted);
            border-radius: 8px;
            font-size: 0.9rem;
            background: var(--dark);
            color: var(--text);
            transition: all 0.3s ease;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
        }

        .custom-select {
            position: relative;
            width: 100%;
        }

        .custom-select-toggle {
            width: 100%;
            padding: 0.7rem;
            border: 1px solid var(--text-muted);
            border-radius: 8px;
            font-size: 0.9rem;
            background: var(--dark);
            color: var(--text);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .custom-select-toggle:hover {
            border-color: var(--primary);
        }

        .custom-select-toggle:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
        }

        .custom-select-options {
            position: absolute;
            left: 0;
            right: 0;
            max-height: 300px;
            overflow-y: auto;
            background: var(--card-background);
            border: 1px solid var(--text-muted);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
        }

        .custom-select-options.show {
            display: block;
        }

        .custom-select-options.open-up {
            bottom: 100%;
            top: auto;
        }

        .custom-select-options.open-down {
            top: 100%;
            bottom: auto;
        }

        .custom-select-option {
            padding: 0.5rem 0.7rem;
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            font-size: 0.85rem;
        }

        .custom-select-option:hover {
            background: var(--primary-dark);
            color: white;
        }

        .custom-select-option.category {
            background: var(--dark);
            color: var(--text-muted);
            font-weight: bold;
            padding: 0.5rem 0.7rem;
            border-top: 1px solid var(--text-muted);
            cursor: default;
        }

        .tooltip {
            position: fixed;
            background: var(--primary-dark);
            color: white;
            padding: 0.5rem 0.8rem;
            border-radius: 4px;
            font-size: 0.8rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
            max-width: 250px;
            pointer-events: none;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .tooltip.show {
            display: block;
        }

        .tooltip::before {
            content: '';
            position: absolute;
            top: 50%;
            left: -6px;
            transform: translateY(-50%);
            border-width: 6px;
            border-style: solid;
            border-color: transparent var(--primary-dark) transparent transparent;
        }

        .btn {
            display: inline-block;
            padding: 0.7rem 1.2rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(124, 58, 237, 0.4);
        }

        .btn:disabled {
            background-color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-group input {
            width: auto;
        }

        .checkbox-group label {
            margin-bottom: 0;
            font-weight: normal;
            font-size: 0.85rem;
        }

        .generated-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            object-fit: contain;
        }

        .generated-image.show {
            opacity: 1;
            visibility: visible;
        }

        .placeholder {
            text-align: center;
            color: var(--text-muted);
        }

        .placeholder i {
            font-size: 3rem;
            color: var(--text-muted);
            margin-bottom: 0.8rem;
        }

        .loading {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--text-muted);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 0.8rem;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .history {
            margin-top: 1.5rem;
            display: none;
        }

        .history.show {
            display: block;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .history h3 {
            margin-bottom: 0.8rem;
            color: var(--primary);
            font-size: 1.2rem;
        }

        .history-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.8rem;
        }

        .history-item {
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.3s ease forwards;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .history-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
        }

        .history-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }

        .history-item .prompt {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.4rem;
            font-size: 0.7rem;
            display: none;
        }

        .history-item:hover .prompt {
            display: block;
        }

        .history-delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .history-item:hover .history-delete-btn {
            display: flex;
        }

        .history-delete-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .history-preview-btn {
            position: absolute;
            top: 4px;
            left: 4px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .history-item:hover .history-preview-btn {
            display: flex;
        }

        .history-preview-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        footer {
            text-align: center;
            margin-top: 1.5rem;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .toast {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background: var(--dark);
            color: white;
            padding: 0.8rem 1.2rem;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 3000;
            font-size: 0.9rem;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        .image-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }

        .image-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .image-overlay img {
            max-width: 90%;
            max-height: 80vh;
            border-radius: 8px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: auto;
            opacity: 0;
            transition: opacity 0.3s ease-in-out 0.05s;
        }

        .image-overlay.show img {
            opacity: 1;
        }

        .image-overlay .close-btn {
            position: absolute;
            top: 0.8rem;
            right: 0.8rem;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .image-overlay .close-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .image-overlay .overlay-buttons {
            position: absolute;
            bottom: 0.8rem;
            right: 0.8rem;
            display: flex;
            gap: 0.8rem;
        }

        .image-overlay .copy-btn,
        .image-overlay .download-btn {
            background: var(--primary);
            color: white;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .image-overlay .copy-btn:hover,
        .image-overlay .download-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .image-overlay .delete-btn {
            position: absolute;
            bottom: 0.8rem;
            left: 0.8rem;
            background: var(--danger);
            color: white;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .image-overlay .delete-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .seed-container {
            position: relative;
        }

        .clear-seed-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0.2rem;
            transition: all 0.3s ease;
        }

        .clear-seed-btn:hover {
            color: var(--danger);
        }

        .custom-select-option.popular {
            background: rgba(124, 58, 237, 0.1);
            font-weight: bold;
        }

        .custom-select-option.popular:hover {
            background: var(--primary-dark);
            color: white;
        }

        .batch-container {
            display: flex;
            gap: 0.8rem;
            align-items: center;
        }

        .tooltip-mobile {
            max-width: 150px;
            font-size: 0.7rem;
            text-align: center;
        }

        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.8rem;
            }

            .controls,
            .image-preview {
                padding: 1rem;
            }

            .image-preview {
                min-height: 300px;
            }

            .generated-image {
                max-height: 300px;
            }

            .form-group {
                margin-bottom: 0.8rem;
            }

            label {
                font-size: 0.9rem;
            }

            input,
            textarea,
            select {
                font-size: 0.85rem;
                padding: 0.6rem;
            }

            .btn {
                font-size: 0.85rem;
                padding: 0.6rem 1rem;
            }

            .history-items {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            .history-item img {
                height: 100px;
            }

            .history-item .prompt {
                font-size: 0.65rem;
            }

            .toast {
                font-size: 0.8rem;
                padding: 0.6rem 1rem;
            }

            .tooltip-mobile {
                left: auto !important;
                right: 10px !important;
            }

            .tooltip-mobile::before {
                left: auto;
                right: -6px;
                border-color: transparent transparent transparent var(--primary-dark);
            }

            .image-overlay {
                align-items: center;
                justify-content: center;
            }

            .image-overlay img {
                max-height: 70vh;
                margin: auto;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem;
            }

            .image-preview {
                min-height: 200px;
            }

            .generated-image {
                max-height: 200px;
            }

            .history-items {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }

            .history-item img {
                height: 80px;
            }

            .history-delete-btn,
            .history-preview-btn {
                width: 18px;
                height: 18px;
                font-size: 0.6rem;
            }

            .image-overlay img {
                max-height: 70vh;
            }

            .image-overlay .copy-btn,
            .image-overlay .download-btn,
            .image-overlay .delete-btn {
                font-size: 0.8rem;
                padding: 0.5rem 0.8rem;
            }

            .image-overlay .close-btn {
                width: 28px;
                height: 28px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Générateur d'images IA</h1>
        </header>

        <div class="app-container">
            <div class="controls">
                <div class="form-group">
                    <label for="prompt">Description de l'image</label>
                    <textarea id="prompt" placeholder="Décrivez l'image que vous souhaitez générer..."></textarea>
                </div>

                <div class="form-group">
                    <label for="model">Modèle</label>
                    <select id="model">
                        <option value="flux" selected>Flux (par défaut)</option>
                        <option value="turbo">Turbo</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="dimensions">Dimensions</label>
                    <select id="dimensions">
                        <option value="512x512">512x512 (Carré, 1:1)</option>
                        <option value="1024x1024">1024x1024 (Carré, 1:1)</option>
                        <option value="800x600">800x600 (Paysage, 4:3)</option>
                        <option value="1024x576">1024x576 (Paysage, 16:9)</option>
                        <option value="1280x720" selected>1280x720 (Paysage, 16:9)</option>
                        <option value="600x800">600x800 (Portrait, 3:4)</option>
                        <option value="576x1024">576x1024 (Portrait, 9:16)</option>
                        <option value="720x1280">720x1280 (Portrait, 9:16)</option>
                        <option value="1600x400">1600x400 (Ultrawide, 4:1)</option>
                        <option value="1920x480">1920x480 (Ultrawide, 4:1)</option>
                        <option value="2048x512">2048x512 (Ultrawide, 4:1)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="seed">Graine (laisser vide pour aléatoire)</label>
                    <div class="seed-container">
                        <input type="text" id="seed" placeholder="Graine aléatoire" pattern="[0-9]*">
                        <button class="clear-seed-btn" id="clear-seed-btn"><i class="fas fa-times"></i></button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="style">Style</label>
                    <div class="custom-select" id="style">
                        <div class="custom-select-toggle">
                            <span class="custom-select-label">Défaut</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="custom-select-options">
                            <div class="custom-select-option" data-value="default"
                                data-tooltip="Style par défaut sans modification esthétique">Défaut</div>
                            <div class="custom-select-option category">──── Populaires ────</div>
                            <div class="custom-select-option popular" data-value="anime"
                                data-tooltip="Style d'animation japonaise avec lignes nettes, couleurs vibrantes et expressions exagérées">
                                Anime</div>
                            <div class="custom-select-option popular" data-value="realistic"
                                data-tooltip="Rendu photoréaliste avec détails précis et textures naturelles">Réaliste
                            </div>
                            <div class="custom-select-option popular" data-value="cartoon"
                                data-tooltip="Style animé avec contours nets et couleurs vives, comme un dessin animé">
                                Cartoon</div>
                            <div class="custom-select-option popular" data-value="oilpainting"
                                data-tooltip="Peinture à l'huile classique avec coups de pinceau épais et couleurs riches">
                                Peinture à l'huile</div>
                            <div class="custom-select-option popular" data-value="watercolor"
                                data-tooltip="Effet de peinture à l'aquarelle avec des couleurs douces et translucides">
                                Aquarelle</div>
                            <div class="custom-select-option popular" data-value="sketch"
                                data-tooltip="Croquis au crayon ou à l'encre avec traits visibles et esthétique minimaliste">
                                Croquis</div>
                            <div class="custom-select-option category">──── Artistiques Classiques ────</div>
                            <div class="custom-select-option" data-value="artdeco"
                                data-tooltip="Style élégant des années 1920 avec des motifs géométriques et dorés">Art
                                Déco</div>
                            <div class="custom-select-option" data-value="baroque"
                                data-tooltip="Esthétique opulente du XVIIe siècle avec des détails riches et dorés">
                                Baroque</div>
                            <div class="custom-select-option" data-value="bauhaus"
                                data-tooltip="Style moderniste avec des formes géométriques et des couleurs primaires">
                                Bauhaus</div>
                            <div class="custom-select-option" data-value="chiaroscuro"
                                data-tooltip="Jeu dramatique de lumière et d'ombre, inspiré des peintures de Caravage">
                                Chiaroscuro</div>
                            <div class="custom-select-option" data-value="expressionist"
                                data-tooltip="Émotions brutes avec des couleurs contrastées et des formes exagérées">
                                Expressionniste</div>
                            <div class="custom-select-option" data-value="gouache"
                                data-tooltip="Peinture épaisse et texturée avec des couleurs vibrantes et des coups de pinceau">
                                Gouache</div>
                            <div class="custom-select-option" data-value="marble"
                                data-tooltip="Esthétique de marbre sculpté avec veines élégantes et tons luxueux">Marbre
                            </div>
                            <div class="custom-select-option" data-value="mosaic"
                                data-tooltip="Motifs composés de petites tuiles colorées, comme l'art byzantin">Mosaïque
                            </div>
                            <div class="custom-select-option" data-value="popart"
                                data-tooltip="Couleurs audacieuses et motifs répétitifs, inspiré d'Andy Warhol">Pop Art
                            </div>
                            <div class="custom-select-option" data-value="surrealist"
                                data-tooltip="Scènes irréelles et oniriques, comme les œuvres de Dalí">Surréaliste</div>
                            <div class="custom-select-option" data-value="ukiyo-e"
                                data-tooltip="Estampes japonaises traditionnelles avec des lignes fluides et des scènes poétiques">
                                Ukiyo-e</div>
                            <div class="custom-select-option category">──── Modernes/Graphiques ────</div>
                            <div class="custom-select-option" data-value="chalkboard"
                                data-tooltip="Style tableau noir avec des traits de craie et une vibe rétro éducative">
                                Tableau Craie</div>
                            <div class="custom-select-option" data-value="glitchart"
                                data-tooltip="Effets visuels numériques cassés avec des distorsions et artefacts colorés">
                                Glitch Art</div>
                            <div class="custom-select-option" data-value="holographic"
                                data-tooltip="Effets irisés et brillants, comme des hologrammes futuristes">
                                Holographique</div>
                            <div class="custom-select-option" data-value="holographicretro"
                                data-tooltip="Holographie rétrofuturiste avec reflets irisés et vibe années 80">
                                Holographique Rétro</div>
                            <div class="custom-select-option" data-value="lowpoly"
                                data-tooltip="Formes géométriques polygonales en 3D minimaliste">Low Poly</div>
                            <div class="custom-select-option" data-value="minimalist"
                                data-tooltip="Design épuré avec peu de détails et des couleurs simples">Minimaliste
                            </div>
                            <div class="custom-select-option" data-value="papercut"
                                data-tooltip="Découpages de papier avec couches superposées et ombres délicates">
                                Papercut</div>
                            <div class="custom-select-option" data-value="pixelart"
                                data-tooltip="Esthétique rétro des jeux vidéo avec des pixels visibles">Pixel Art</div>
                            <div class="custom-select-option" data-value="vectorart"
                                data-tooltip="Graphismes épurés avec des lignes nettes et des formes plates">Vector Art
                            </div>
                            <div class="custom-select-option category">──── Futuristes ────</div>
                            <div class="custom-select-option" data-value="afrofuturism"
                                data-tooltip="Fusion de science-fiction et culture africaine avec des motifs vibrants">
                                Afrofuturisme</div>
                            <div class="custom-select-option" data-value="biopunk"
                                data-tooltip="Technologie organique et mutations dans une vibe dystopique">Biopunk</div>
                            <div class="custom-select-option" data-value="cyberpunk"
                                data-tooltip="Ambiance high-tech sombre avec néons et dystopie urbaine">Cyberpunk</div>
                            <div class="custom-select-option" data-value="dieselpunk"
                                data-tooltip="Style rétro-futuriste des années 30-40 avec machines robustes">Dieselpunk
                            </div>
                            <div class="custom-select-option" data-value="neonnoir"
                                data-tooltip="Mélange de cyberpunk et film noir avec néons et ambiance pluvieuse">Néon
                                Noir</div>
                            <div class="custom-select-option" data-value="retrofuture"
                                data-tooltip="Vision du futur des années 50-60 avec fusées et dômes vintage">
                                Rétrofuturiste</div>
                            <div class="custom-select-option" data-value="solarpunk"
                                data-tooltip="Futur écologique utopique avec technologies vertes et nature">Solarpunk
                            </div>
                            <div class="custom-select-option" data-value="synthwave"
                                data-tooltip="Esthétique rétro-futuriste des années 80 avec néons et grilles">Synthwave
                            </div>
                            <div class="custom-select-option category">──── Fantastiques/Magiques ────</div>
                            <div class="custom-select-option" data-value="bioluminescent"
                                data-tooltip="Lueurs néon comme des organismes bioluminescents, vibe sous-marine magique">
                                Bioluminescent</div>
                            <div class="custom-select-option" data-value="biopoetic"
                                data-tooltip="Formes organiques fluides avec une ambiance vivante et poétique">
                                Biopoétique</div>
                            <div class="custom-select-option" data-value="dreamscape"
                                data-tooltip="Scènes irréelles et floues, comme dans un rêve">Paysage Onirique</div>
                            <div class="custom-select-option" data-value="enchanted"
                                data-tooltip="Ambiance magique avec lueurs douces et éléments féeriques">Enchanté</div>
                            <div class="custom-select-option" data-value="ethereal"
                                data-tooltip="Esthétique aérienne avec tons pastel et légèreté surnaturelle">Éthéré
                            </div>
                            <div class="custom-select-option" data-value="fantasy"
                                data-tooltip="Univers épiques avec créatures et paysages fantastiques">Fantaisie</div>
                            <div class="custom-select-option" data-value="luminist"
                                data-tooltip="Ambiance centrée sur la lumière avec halos et reflets divins">Luministe
                            </div>
                            <div class="custom-select-option" data-value="mythic"
                                data-tooltip="Scènes inspirées des mythologies avec une aura sacrée">Mythique</div>
                            <div class="custom-select-option" data-value="whimsical"
                                data-tooltip="Ambiance ludique avec éléments excentriques et couleurs douces">
                                Fantaisiste</div>
                            <div class="custom-select-option category">──── Sombres/Dramatiques ────</div>
                            <div class="custom-select-option" data-value="apocalyptic"
                                data-tooltip="Scènes post-apocalyptiques avec ruines et cieux sombres">Apocalyptique
                            </div>
                            <div class="custom-select-option" data-value="gothic"
                                data-tooltip="Ambiance mystérieuse avec tons sombres et détails ornés">Gothique</div>
                            <div class="custom-select-option" data-value="noir"
                                data-tooltip="Esthétique monochrome des films noirs avec ombres dramatiques">Noir (Film
                                Noir)</div>
                            <div class="custom-select-option" data-value="xenomorphic"
                                data-tooltip="Formes biomécaniques extraterrestres, inspirées de H.R. Giger">Xénomorphe
                            </div>
                            <div class="custom-select-option category">──── Vibrants/Alternatifs ────</div>
                            <div class="custom-select-option" data-value="fractal"
                                data-tooltip="Motifs géométriques complexes et répétitifs, comme des fractales">Fractal
                            </div>
                            <div class="custom-select-option" data-value="graffiti"
                                data-tooltip="Style urbain avec couleurs vives et motifs de street art">Graffiti</div>
                            <div class="custom-select-option" data-value="grunge"
                                data-tooltip="Esthétique brute avec textures rugueuses et couleurs désaturées">Grunge
                            </div>
                            <div class="custom-select-option" data-value="kawaii"
                                data-tooltip="Style japonais mignon avec personnages adorables et pastel">Kawaii</div>
                            <div class="custom-select-option" data-value="prismatic"
                                data-tooltip="Couleurs éclatantes réfractées, comme à travers un prisme">Prismatique
                            </div>
                            <div class="custom-select-option" data-value="psychedelic"
                                data-tooltip="Couleurs vives et motifs tourbillonnants, ambiance années 60">
                                Psychédélique</div>
                            <div class="custom-select-option" data-value="vaporwave"
                                data-tooltip="Nostalgie rétro des années 80-90 avec néons et pastel">Vaporwave</div>
                            <div class="custom-select-option category">──── Décoratifs ────</div>
                            <div class="custom-select-option" data-value="claymation"
                                data-tooltip="Style pâte à modeler avec textures douces et vibe artisanale">Claymation
                            </div>
                            <div class="custom-select-option" data-value="knitted"
                                data-tooltip="Textures de laine avec motifs entrelacés, vibe chaleureuse et artisanale">
                                Tricoté</div>
                            <div class="custom-select-option" data-value="origami"
                                data-tooltip="Esthétique de pliage de papier avec formes géométriques nettes">Origami
                            </div>
                            <div class="custom-select-option" data-value="stainedglass"
                                data-tooltip="Couleurs vibrantes séparées par des lignes noires, comme un vitrail">
                                Vitrail</div>
                            <div class="custom-select-option" data-value="velvet"
                                data-tooltip="Textures riches de velours avec couleurs profondes et ambiance opulente">
                                Velours</div>
                            <div class="custom-select-option category">──── Cosmiques ────</div>
                            <div class="custom-select-option" data-value="cosmic"
                                data-tooltip="Ambiance spatiale avec étoiles, galaxies et tons profonds">Cosmique</div>
                            <div class="custom-select-option" data-value="microscopic"
                                data-tooltip="Images au microscope avec détails cellulaires et couleurs fluorescentes">
                                Microscopique</div>
                            <div class="custom-select-option category">──── Steampunk ────</div>
                            <div class="custom-select-option" data-value="steampunk"
                                data-tooltip="Machines rétro-futuristes avec engrenages et vapeur">Steampunk</div>
                            <div class="custom-select-option category">──── Audacieux ────</div>
                            <div class="custom-select-option" data-value="boudoir"
                                data-tooltip="Style intime et luxueux avec textures soyeuses et sensualité raffinée">
                                Boudoir</div>
                            <div class="custom-select-option" data-value="cabaret"
                                data-tooltip="Spectacles burlesques avec couleurs riches et vibe théâtrale provocante">
                                Cabaret</div>
                            <div class="custom-select-option" data-value="erotic"
                                data-tooltip="Art sensuel avec formes fluides et ambiance suggestive">Érotique</div>
                            <div class="custom-select-option" data-value="fetishnoir"
                                data-tooltip="Ambiance sombre avec cuir, contrastes forts et mystère audacieux">Fetish
                                Noir</div>
                            <div class="custom-select-option" data-value="pinup"
                                data-tooltip="Style rétro des années 50 avec poses audacieuses et glamour espiègle">
                                Pin-Up</div>
                        </div>
                    </div>
                    <input type="hidden" id="style-value" name="style" value="default">
                </div>

                <div class="form-group">
                    <label>Options</label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="enhance" checked>
                        <label for="enhance">Améliorer la description avec l'IA</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="high-detail">
                        <label for="high-detail">Haute résolution (8k, détails élevés)</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="safe">
                        <label for="safe">Filtre NSFW</label>
                    </div>
                </div>

                <div class="batch-container">
                    <select id="batch-size" style="width: 80px;">
                        <option value="1" selected>1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                    </select>
                    <button id="generate-btn" class="btn btn-block">
                        <i class="fas fa-magic"></i> Générer l'image
                    </button>
                </div>
            </div>
            <div class="image-preview">
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>Génération de votre image...</p>
                </div>

                <div id="placeholder" class="placeholder">
                    <i class="fas fa-image"></i>
                    <p>Votre image générée apparaîtra ici</p>
                </div>

                <img id="generated-image" class="generated-image" alt="Image générée">
            </div>
        </div>

        <div class="history">
            <div class="history-header">
                <h3>Historique des générations</h3>
                <button id="clear-history-btn" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Effacer l'Historique
                </button>
            </div>
            <div id="history-items" class="history-items">
            </div>
        </div>

        <footer>
            <p>Propulsé par Elgabo ✨</p><br>
        </footer>
    </div>

    <div id="image-overlay" class="image-overlay">
        <img id="overlay-image" src="" alt="Image agrandie">
        <button class="close-btn" id="close-overlay"><i class="fas fa-times"></i></button>
        <button class="delete-btn" id="overlay-delete"><i class="fas fa-trash"></i> Supprimer</button>
        <div class="overlay-buttons">
            <button class="copy-btn copy-btn-mobile" id="overlay-copy"><i class="fas fa-copy"></i> Copier</button>
            <button class="download-btn" id="overlay-download"><i class="fas fa-download"></i> Télécharger</button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <div id="tooltip" class="tooltip"></div>

    <script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
            return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
            if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
                try {
                    var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                    var firstSheetName = workbook.SheetNames[0];
                    var worksheet = workbook.Sheets[firstSheetName];

                    // Convert sheet to JSON to filter blank rows
                    var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                    // Filter out blank rows (rows where all cells are empty, null, or undefined)
                    var filteredData = jsonData.filter(row => row.some(filledCell));

                    // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                    var headerRowIndex = filteredData.findIndex((row, index) =>
                        row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                    );
                    // Fallback
                    if (headerRowIndex === -1 || headerRowIndex > 25) {
                        headerRowIndex = 0;
                    }

                    // Convert filtered JSON back to CSV
                    var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                    csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                    return csv;
                } catch (e) {
                    console.error(e);
                    return "";
                }
            }
            return gk_fileData[filename] || "";
        }
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let isGenerating = false;
            let isWaiting = false;
            let currentPrompt = '';
            let abortController = null;
            let batchInProgress = false;
            let batchCount = 0;
            let currentBatchSize = 0;
            let lastClickTime = 0;
            const isMobile = window.matchMedia("(max-width: 768px)").matches;

            // Masquer le bouton Copier sur mobile
            const copyBtn = document.querySelector('.copy-btn-mobile');
            if (isMobile && copyBtn) {
                copyBtn.style.display = 'none';
            }

            document.getElementById('prompt').value = '';
            document.getElementById('model').value = 'flux';
            document.getElementById('dimensions').value = '1280x720';
            document.getElementById('seed').value = '';
            document.getElementById('style-value').value = 'default';
            document.getElementById('batch-size').value = '1';
            document.getElementById('generated-image').classList.remove('show');
            document.getElementById('placeholder').style.display = 'block';
            document.getElementById('image-overlay').classList.remove('show');

            const promptTextarea = document.getElementById('prompt');
            promptTextarea.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    if (!isMobile) {
                        e.preventDefault(); // Prevent newline on desktop
                        if (!isGenerating && !batchInProgress) {
                            generateImage();
                        }
                    }
                    // On mobile, allow default behavior (newline)
                }
            });

            const customSelect = document.querySelector('.custom-select');
            const toggle = customSelect.querySelector('.custom-select-toggle');
            const options = customSelect.querySelector('.custom-select-options');
            const selectLabel = customSelect.querySelector('.custom-select-label');
            const styleInput = document.getElementById('style-value');
            const tooltip = document.getElementById('tooltip');

            toggle.addEventListener('click', () => {
                const toggleRect = toggle.getBoundingClientRect();
                const optionsHeight = 300;
                const spaceBelow = window.innerHeight - toggleRect.bottom;
                const spaceAbove = toggleRect.top;

                options.classList.remove('open-up', 'open-down');
                if (spaceBelow < optionsHeight && spaceAbove > spaceBelow) {
                    options.classList.add('open-up');
                } else {
                    options.classList.add('open-down');
                }

                options.classList.toggle('show');
            });

            document.querySelectorAll('.custom-select-option:not(.category)').forEach(option => {
                option.addEventListener('click', () => {
                    const value = option.getAttribute('data-value');
                    selectLabel.textContent = option.textContent;
                    styleInput.value = value;
                    options.classList.remove('show');
                    tooltip.classList.remove('show');
                });

                option.addEventListener('mouseover', () => {
                    const tooltipText = option.getAttribute('data-tooltip');
                    if (tooltipText) {
                        tooltip.textContent = tooltipText;
                        tooltip.classList.add('show');

                        const rect = option.getBoundingClientRect();
                        if (isMobile) {
                            tooltip.classList.add('tooltip-mobile');
                            tooltip.style.top = `${rect.top - tooltip.offsetHeight - 5 + window.scrollY}px`;
                            tooltip.style.right = '10px';
                            tooltip.style.left = 'auto';
                        } else {
                            tooltip.style.top = `${rect.top + (rect.height / 2) - (tooltip.offsetHeight / 2)}px`;
                            tooltip.style.left = `${rect.right + window.scrollX + 10}px`;

                            const tooltipRect = tooltip.getBoundingClientRect();
                            if (tooltipRect.right > window.innerWidth) {
                                tooltip.style.left = `${rect.left + window.scrollX - tooltipRect.width - 10}px`;
                                tooltip.classList.add('left');
                            } else {
                                tooltip.classList.remove('left');
                            }
                        }
                    }
                });

                option.addEventListener('mouseout', () => {
                    tooltip.classList.remove('show');
                });
            });

            document.addEventListener('click', (e) => {
                if (!customSelect.contains(e.target)) {
                    options.classList.remove('show');
                    tooltip.classList.remove('show');
                }
            });

            const generateBtn = document.getElementById('generate-btn');
            generateBtn.addEventListener('click', () => {
                if (batchInProgress) {
                    stopBatchGeneration();
                } else if (isGenerating) {
                    stopGeneration();
                } else {
                    const batchSize = parseInt(document.getElementById('batch-size').value);
                    if (batchSize > 1) {
                        startBatchGeneration(batchSize);
                    } else {
                        generateImage();
                    }
                }
            });

            const clearHistoryBtn = document.getElementById('clear-history-btn');
            clearHistoryBtn.addEventListener('click', () => {
                if (window.confirm('Voulez-vous vraiment effacer tout l\'historique des images générées ? Cette action est irréversible.')) {
                    clearHistory();
                }
            });

            const clearSeedBtn = document.getElementById('clear-seed-btn');
            clearSeedBtn.addEventListener('click', () => {
                document.getElementById('seed').value = '';
            });

            const generatedImage = document.getElementById('generated-image');
            const imageOverlay = document.getElementById('image-overlay');
            const overlayImage = document.getElementById('overlay-image');
            const overlayDownload = document.getElementById('overlay-download');
            const overlayCopy = document.getElementById('overlay-copy');
            const overlayDelete = document.getElementById('overlay-delete');
            const closeOverlay = document.getElementById('close-overlay');

            generatedImage.addEventListener('click', () => {
                if (generatedImage.classList.contains('show') && generatedImage.src) {
                    overlayImage.src = generatedImage.src;
                    setTimeout(() => {
                        imageOverlay.classList.add('show');
                    }, 0);
                }
            });

            overlayDownload.addEventListener('click', () => {
                const base64Data = overlayImage.src.split(',')[1];
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'image/jpeg' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = generateFileName(currentPrompt);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            });

            overlayCopy.addEventListener('click', () => {
                try {
                    convertToPng(overlayImage.src)
                        .then(blob => {
                            const item = new ClipboardItem({ 'image/png': blob });
                            return navigator.clipboard.write([item]);
                        })
                        .then(() => {
                            showToast('Image copiée dans le presse-papiers !', 'success');
                        })
                        .catch(error => {
                            console.error('Failed to copy image:', error);
                            showToast('Erreur lors de la copie de l\'image. Essayez un autre navigateur.', 'error');
                        });
                } catch (error) {
                    console.error('Clipboard error:', error);
                    showToast('Erreur d\'accès au presse-papiers. Vérifiez les permissions.', 'error');
                }
            });

            overlayDelete.addEventListener('click', () => {
                const imageUrl = overlayImage.src;
                let history = JSON.parse(localStorage.getItem('imageHistory') || '[]');
                history = history.filter(item => item.imageUrl !== imageUrl);
                localStorage.setItem('imageHistory', JSON.stringify(history));
                loadHistory();
                showToast('Image supprimée de l\'historique !', 'success');
                generatedImage.classList.remove('show');
                generatedImage.src = '';
                document.getElementById('placeholder').style.display = 'block';
                document.getElementById('prompt').value = '';
                document.getElementById('model').value = 'flux';
                document.getElementById('dimensions').value = '1280x720';
                document.getElementById('seed').value = '';
                document.getElementById('style-value').value = 'default';
                document.querySelector('.custom-select-label').textContent = 'Défaut';
                imageOverlay.classList.remove('show');
            });

            closeOverlay.addEventListener('click', () => {
                imageOverlay.classList.remove('show');
            });

            imageOverlay.addEventListener('click', (e) => {
                if (e.target === imageOverlay) {
                    imageOverlay.classList.remove('show');
                }
            });

            function centerImageOnMobile() {
                if (isMobile) {
                    const imagePreview = document.querySelector('.image-preview');
                    setTimeout(() => {
                        imagePreview.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 200);
                }
            }

            function loadHistory() {
                const history = JSON.parse(localStorage.getItem('imageHistory') || '[]');
                const historyContainer = document.getElementById('history-items');
                const historySection = document.querySelector('.history');

                historyContainer.innerHTML = '';

                if (history.length === 0) {
                    historySection.classList.remove('show');
                    return;
                }

                historySection.classList.add('show');

                history.forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.innerHTML = `
                        <img src="${item.imageUrl}" alt="${item.originalPrompt}">
                        <button class="history-preview-btn"><i class="fas fa-eye"></i></button>
                        <button class="history-delete-btn"><i class="fas fa-times"></i></button>
                        <div class="prompt">${item.originalPrompt}</div>
                    `;

                    const previewBtn = historyItem.querySelector('.history-preview-btn');
                    previewBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        overlayImage.src = item.imageUrl;
                        setTimeout(() => {
                            imageOverlay.classList.add('show');
                        }, 0);
                    });

                    const deleteBtn = historyItem.querySelector('.history-delete-btn');
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        let history = JSON.parse(localStorage.getItem('imageHistory') || '[]');
                        history = history.filter(h => h.imageUrl !== item.imageUrl);
                        localStorage.setItem('imageHistory', JSON.stringify(history));
                        loadHistory();
                        showToast('Image supprimée de l\'historique !', 'success');
                        if (generatedImage.src === item.imageUrl) {
                            generatedImage.classList.remove('show');
                            generatedImage.src = '';
                            document.getElementById('placeholder').style.display = 'block';
                        }
                    });

                    historyItem.addEventListener('click', () => {
                        const now = Date.now();
                        if (now - lastClickTime < 300) return;
                        lastClickTime = now;

                        document.getElementById('prompt').value = item.originalPrompt;

                        generatedImage.classList.remove('show');
                        setTimeout(() => {
                            generatedImage.src = item.imageUrl;
                            generatedImage.classList.add('show');
                            document.getElementById('placeholder').style.display = 'none';
                        }, 300);

                        document.getElementById('seed').value = item.seed || '';
                        document.getElementById('model').value = item.model || 'flux';
                        document.getElementById('dimensions').value = item.dimensions || '1280x720';
                        document.getElementById('style-value').value = item.style || 'default';
                        document.querySelector('.custom-select-label').textContent =
                            document.querySelector(`.custom-select-option[data-value="${item.style || 'default'}"]`).textContent;
                        currentPrompt = item.originalPrompt;
                    });

                    historyContainer.prepend(historyItem);
                });
            }

            function clearHistory() {
                localStorage.removeItem('imageHistory');
                loadHistory();
                generatedImage.classList.remove('show');
                generatedImage.src = '';
                document.getElementById('placeholder').style.display = 'block';
                document.getElementById('prompt').value = '';
                document.getElementById('model').value = 'flux';
                document.getElementById('dimensions').value = '1280x720';
                document.getElementById('seed').value = '';
                document.getElementById('style-value').value = 'default';
                document.querySelector('.custom-select-label').textContent = 'Défaut';
                document.getElementById('image-overlay').classList.remove('show');
                showToast('Historique effacé !', 'success');
            }

            function showToast(message, type = '') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = 'toast';
                toast.classList.add(type);
                if (isMobile) {
                    toast.style.fontSize = '0.8rem';
                }
                setTimeout(() => {
                    toast.classList.add('show');
                }, 100);

                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            function startCooldown() {
                isWaiting = true;
                let timeLeft = 3;
                generateBtn.disabled = true;
                const originalText = '<i class="fas fa-magic"></i> Générer l\'image';
                generateBtn.innerHTML = `Attendez ${timeLeft}s`;

                const countdown = setInterval(() => {
                    timeLeft--;
                    generateBtn.innerHTML = `Attendez ${timeLeft}s`;
                    if (timeLeft <= 0) {
                        clearInterval(countdown);
                        generateBtn.innerHTML = batchInProgress ? '<i class="fas fa-stop"></i> Arrêter le batch' : originalText;
                        generateBtn.disabled = false;
                        isWaiting = false;
                    }
                }, 1000);
            }

            function generateFileName(prompt) {
                let cleanPrompt = prompt
                    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                    .replace(/[^a-zA-Z0-9\s-]/g, '')
                    .trim()
                    .replace(/\s+/g, '-')
                    .toLowerCase();
                if (cleanPrompt.length > 50) {
                    cleanPrompt = cleanPrompt.substring(0, 50);
                    cleanPrompt = cleanPrompt.substring(0, cleanPrompt.lastIndexOf('-') + 1) || cleanPrompt;
                }
                return cleanPrompt ? `${cleanPrompt}.jpg` : 'image-ia.jpg';
            }

            function blobToBase64(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }

            function convertToPng(imageSrc) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = 'Anonymous';
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        canvas.toBlob(blob => {
                            if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error('Failed to convert image to PNG'));
                            }
                        }, 'image/png');
                    };
                    img.onerror = () => reject(new Error('Failed to load image for conversion'));
                    img.src = imageSrc;
                });
            }

            function stopGeneration() {
                if (abortController) {
                    abortController.abort();
                }
                isGenerating = false;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('placeholder').style.display = 'block';
                generatedImage.classList.remove('show');
                generatedImage.src = '';
                generateBtn.innerHTML = '<i class="fas fa-magic"></i> Générer l\'image';
                showToast('Génération arrêtée.', 'error');
                document.getElementById('seed').value = '';
                startCooldown();
            }

            function stopBatchGeneration() {
                if (abortController) {
                    abortController.abort();
                }
                isGenerating = false;
                batchInProgress = false;
                batchCount = 0;
                currentBatchSize = 0;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('placeholder').style.display = 'block';
                generatedImage.classList.remove('show');
                generatedImage.src = '';
                generateBtn.innerHTML = '<i class="fas fa-magic"></i> Générer l\'image';
                showToast('Génération par batch arrêtée.', 'error');
                document.getElementById('seed').value = '';
                startCooldown();
            }

            async function startBatchGeneration(batchSize) {
                if (isWaiting || batchInProgress) {
                    showToast('Veuillez attendre avant de lancer un nouveau batch.', 'error');
                    return;
                }

                const prompt = document.getElementById('prompt').value.trim();
                if (!prompt) {
                    showToast('Veuillez entrer une description', 'error');
                    return;
                }

                currentPrompt = prompt;
                batchInProgress = true;
                currentBatchSize = batchSize;
                batchCount = 0;

                generateBtn.innerHTML = '<i class="fas fa-stop"></i> Arrêter le batch';

                for (let i = 0; i < batchSize && batchInProgress; i++) {
                    await generateImage();
                    if (batchInProgress && i < batchSize - 1) {
                        await new Promise(resolve => setTimeout(resolve, 3000));
                    }
                }

                if (batchInProgress) {
                    batchInProgress = false;
                    batchCount = 0;
                    currentBatchSize = 0;
                    generateBtn.innerHTML = '<i class="fas fa-magic"></i> Générer l\'image';
                }
            }

            async function generateImage() {
                if (isWaiting && !batchInProgress) {
                    showToast('Veuillez attendre avant de générer une nouvelle image.', 'error');
                    return;
                }

                const prompt = document.getElementById('prompt').value.trim();
                if (!prompt) {
                    showToast('Veuillez entrer une description', 'error');
                    return;
                }

                currentPrompt = prompt;
                isGenerating = true;
                abortController = new AbortController();

                document.getElementById('loading').style.display = 'flex';
                document.getElementById('placeholder').style.display = 'none';
                generatedImage.classList.remove('show');
                generateBtn.innerHTML = '<i class="fas fa-stop"></i> Arrêter';
                generateBtn.disabled = false;

                const model = document.getElementById('model').value;
                const dimensions = document.getElementById('dimensions').value;
                const [width, height] = dimensions.split('x').map(Number);
                let seed = document.getElementById('seed').value.trim();
                const style = document.getElementById('style-value').value;
                const enhance = document.getElementById('enhance').checked;
                const highDetail = document.getElementById('high-detail').checked;
                const safe = document.getElementById('safe').checked;

                let finalPrompt = prompt;
                if (style !== 'default') {
                    finalPrompt += `, in ${style} style`;
                }
                if (highDetail) {
                    finalPrompt = `highly detailed, 8k resolution, ${finalPrompt}`;
                }

                let aspectRatio;
                if (width === height) aspectRatio = '1:1';
                else if (width === 800 && height === 600) aspectRatio = '4:3';
                else if ((width === 1024 && height === 576) || (width === 1280 && height === 720)) aspectRatio = '16:9';
                else if (width === 600 && height === 800) aspectRatio = '3:4';
                else if ((width === 576 && height === 1024) || (width === 720 && height === 1280)) aspectRatio = '9:16';
                else if ((width === 1600 && height === 400) || (width === 1920 && height === 480) || (width === 2048 && height === 512)) aspectRatio = '4:1';
                else aspectRatio = `${width}:${height}`;

                finalPrompt += `, aspect ratio ${aspectRatio}`;
                finalPrompt = finalPrompt.replace(/[^\x20-\x7E]/g, '');

                if (!seed) {
                    seed = Math.floor(Math.random() * 1000000).toString();
                } else {
                    seed = parseInt(seed);
                    if (isNaN(seed)) seed = Math.floor(Math.random() * 1000000).toString();
                }

                let apiUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}`;
                apiUrl += `?model=${model}&width=${width}&height=${height}`;
                apiUrl += `&nologo=true&private=true`;
                if (seed) apiUrl += `&seed=${seed}`;
                if (enhance) apiUrl += `&enhance=true`;
                if (safe) apiUrl += `&safe=true`;
                apiUrl += `&tamp=${Date.now()}`;

                try {
                    const response = await fetch(apiUrl, { signal: abortController.signal });
                    if (!response.ok) throw new Error('Échec de la génération de l\'image.');

                    const blob = await response.blob();
                    const base64Image = await blobToBase64(blob);

                    generatedImage.src = base64Image;
                    generatedImage.classList.add('show');
                    document.getElementById('loading').style.display = 'none';

                    document.getElementById('seed').value = '';

                    addToHistory({ originalPrompt: prompt, imageUrl: base64Image, model, dimensions, style, seed });
                    showToast('Image générée avec succès !', 'success');
                    centerImageOnMobile();
                } catch (error) {
                    if (error.name === 'AbortError') {
                        showToast('Génération annulée.', 'error');
                    } else {
                        console.error('Erreur lors de la génération:', error);
                        showToast(error.message || 'Erreur lors de la génération de l\'image.', 'error');
                        document.getElementById('placeholder').style.display = 'block';
                    }
                    document.getElementById('seed').value = '';
                } finally {
                    isGenerating = false;
                    document.getElementById('loading').style.display = 'none';
                    generateBtn.innerHTML = '<i class="fas fa-magic"></i> Générer l\'image';
                    startCooldown();
                }
            }

            function addToHistory(item) {
                let history = JSON.parse(localStorage.getItem('imageHistory') || '[]');
                history.unshift(item);
                if (history.length > 50) history = history.slice(0, 50);
                localStorage.setItem('imageHistory', JSON.stringify(history));
                loadHistory();
            }

            loadHistory();
        });
    </script>
</body>

</html>