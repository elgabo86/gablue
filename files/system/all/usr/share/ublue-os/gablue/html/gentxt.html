<!DOCTYPE html>
<html lang="fr">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Générateur de texte IA</title>
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
 <style>
 :root {
 --primary: #7c3aed;
 --primary-dark: #6d28d9;
 --secondary: #22d3ee;
 --dark: #1f2937;
 --light: #e5e7eb;
 --danger: #ef4444;
 --success: #10b981;
 --warning: #f59e0b;
 --background: #111827;
 --card-background: #1f2937;
 --text: #d1d5db;
 --text-muted: #9ca3af;
 --user-bg: #2d3748;
 --ai-bg: #4a5568;
 }

 * {
 margin: 0;
 padding: 0;
 box-sizing: border-box;
 font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
 }

 body {
 background-color: var(--background);
 color: var(--text);
 line-height: 1.6;
 font-size: 0.95rem;
 }

 .container {
 max-width: 1200px;
 margin: 0 auto;
 padding: 1.5rem;
 }

 header {
 text-align: center;
 margin-bottom: 1.5rem;
 }

 h1 {
 font-size: 2rem;
 margin-bottom: 0.4rem;
 color: var(--light);
 text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
 }

 .subtitle {
 color: var(--text-muted);
 font-size: 0.95rem;
 }

 .controls {
 background: var(--card-background);
 padding: 0.8rem;
 border-radius: 10px;
 box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
 display: flex;
 flex-wrap: wrap;
 gap: 0.8rem;
 align-items: center;
 position: sticky;
 top: 0;
 z-index: 100;
 }

 .control-icons {
 display: flex;
 gap: 0.4rem;
 align-items: center;
 }

 .control-icon {
 color: var(--text-muted);
 cursor: pointer;
 font-size: 1.3rem;
 }

 .control-icon:hover {
 color: var(--primary);
 }

 .clear-conversation-icon {
 color: var(--text-muted);
 cursor: pointer;
 font-size: 1.3rem;
 }

 .clear-conversation-icon:hover {
 color: var(--danger);
 }

 .system-prompt-container {
 flex: 1;
 display: flex;
 gap: 0.8rem;
 align-items: center;
 }

 .system-prompt {
 flex: 1;
 min-height: 35px;
 max-height: 70px;
 }

 .text-preview {
 margin-top: 0.8rem;
 padding: 1.5rem;
 background: var(--dark);
 border-radius: 10px;
 box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
 display: flex;
 flex-direction: column;
 min-height: 350px;
 position: relative;
 }

 .form-group {
 margin-bottom: 0.8rem;
 }

 .form-group.hidden {
 display: none;
 }

 label {
 display: block;
 margin-bottom: 0.4rem;
 font-weight: 600;
 color: var(--text);
 font-size: 0.9rem;
 }

 input, select, textarea {
 width: 100%;
 padding: 0.7rem 0.9rem;
 border: 1px solid var(--text-muted);
 border-radius: 7px;
 font-size: 0.9rem;
 background: var(--dark);
 color: var(--text);
 transition: all 0.3s ease;
 }

 textarea {
 resize: none;
 }

 input:focus, select:focus, textarea:focus {
 outline: none;
 border-color: var(--primary);
 box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.2);
 }

 .input-container {
 position: relative;
 }

 .clear-icon {
 position: absolute;
 right: 8px;
 top: 50%;
 transform: translateY(-50%);
 color: var(--text-muted);
 cursor: pointer;
 display: none;
 font-size: 0.9rem;
 }

 .clear-icon.visible {
 display: block;
 }

 .clear-icon:hover {
 color: var(--danger);
 }

 input[type="text"], textarea {
 -webkit-appearance: none;
 -moz-appearance: textfield;
 appearance: none;
 }

 .chat-container {
 flex: 1;
 overflow-y: auto;
 margin-bottom: 0.8rem;
 margin-top: 0.8rem;
 }

 .chat-messages {
 display: flex;
 flex-direction: column;
 gap: 0.8rem;
 }

 .message-container {
 display: flex;
 flex-direction: column;
 gap: 0.4rem;
 }

 .message {
 max-width: 80%;
 padding: 0.7rem 1rem;
 border-radius: 7px;
 font-size: 0.9rem;
 line-height: 1.4;
 white-space: pre-wrap;
 position: relative;
 }

 .message.user {
 align-self: flex-end;
 background-color: var(--user-bg);
 color: var(--text);
 cursor: pointer;
 }

 .message.ai {
 align-self: flex-start;
 background-color: var(--ai-bg);
 color: var(--text);
 }

 .message.user:hover .edit-icon {
 display: block;
 }

 .edit-icon {
 position: absolute;
 top: 4px;
 right: 4px;
 color: var(--text-muted);
 font-size: 0.8rem;
 display: none;
 cursor: pointer;
 transition: color 0.3s ease;
 }

 .edit-icon:hover {
 color: var(--secondary);
 }

 .message-actions {
 display: flex;
 gap: 0.4rem;
 margin-top: 0.4rem;
 }

 .message-actions.ai {
 justify-content: flex-start;
 }

 .message-actions button {
 padding: 0.4rem 0.8rem;
 border: none;
 border-radius: 7px;
 font-size: 0.85rem;
 cursor: pointer;
 transition: all 0.3s ease;
 }

 .message-actions .regenerate-btn {
 background-color: var(--primary);
 color: white;
 }

 .message-actions .regenerate-btn:hover {
 background-color: var(--primary-dark);
 }

 .edit-prompt-container {
 display: none;
 width: 100%;
 margin-top: 0.4rem;
 }

 .edit-prompt-container.active {
 display: block;
 }

 .edit-prompt-container textarea {
 min-height: 35px;
 max-height: 100px;
 width: 100%;
 }

 .edit-prompt-container .save-btn {
 margin-top: 0.4rem;
 padding: 0.4rem 0.8rem;
 background-color: var(--success);
 color: white;
 border: none;
 border-radius: 7px;
 cursor: pointer;
 font-size: 0.85rem;
 }

 .edit-prompt-container .save-btn:hover {
 background-color: #059669;
 }

 .chat-input-container {
 display: flex;
 gap: 0.4rem;
 }

 .chat-input {
 flex: 1;
 min-height: 35px;
 max-height: 100px;
 }

 .btn {
 display: inline-block;
 padding: 0.7rem 1.2rem;
 background-color: var(--primary);
 color: white;
 border: none;
 border-radius: 7px;
 font-size: 0.9rem;
 font-weight: 600;
 cursor: pointer;
 transition: all 0.3s ease;
 text-align: center;
 }

 .btn:hover {
 background-color: var(--primary-dark);
 transform: translateY(-2px);
 box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
 }

 .btn:disabled {
 background-color: var(--text-muted);
 cursor: not-allowed;
 transform: none;
 box-shadow: none;
 }

 .btn-danger {
 background-color: var(--danger);
 }

 .btn-danger:hover {
 background-color: #dc2626;
 }

 .placeholder {
 text-align: center;
 color: var(--text-muted);
 flex: 1;
 display: flex;
 flex-direction: column;
 justify-content: center;
 }

 .placeholder i {
 font-size: 3.5rem;
 color: var(--text-muted);
 margin-bottom: 0.8rem;
 }

 .loading {
 display: none;
 position: absolute;
 top: 0;
 left: 0;
 right: 0;
 bottom: 0;
 background: rgba(0, 0, 0, 0.8);
 display: flex;
 flex-direction: column;
 align-items: center;
 justify-content: center;
 z-index: 10;
 }

 .spinner {
 width: 40px;
 height: 40px;
 border: 4px solid var(--text-muted);
 border-top: 4px solid var(--primary);
 border-radius: 50%;
 animation: spin 1s linear infinite;
 margin-bottom: 0.8rem;
 }

 @keyframes spin {
 0% { transform: rotate(0deg); }
 100% { transform: rotate(360deg); }
 }

 .overlay {
 display: none;
 position: fixed;
 top: 0;
 left: 0;
 right: 0;
 bottom: 0;
 background: rgba(0, 0, 0, 0.7);
 z-index: 200;
 align-items: center;
 justify-content: center;
 }

 .overlay.show {
 display: flex;
 }

 .overlay-content {
 background: var(--card-background);
 padding: 1.5rem;
 border-radius: 10px;
 box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
 width: 90%;
 max-width: 350px;
 }

 .overlay-content h3 {
 margin-bottom: 0.8rem;
 color: var(--primary);
 font-size: 1.2rem;
 }

 .close-overlay {
 float: right;
 color: var(--text-muted);
 cursor: pointer;
 font-size: 1.1rem;
 }

 .close-overlay:hover {
 color: var(--danger);
 }

 .history {
 margin-top: 1.5rem;
 display: none;
 }

 .history.show {
 display: block;
 }

 .history-header {
 display: flex;
 justify-content: space-between;
 align-items: center;
 margin-bottom: 0.8rem;
 }

 .history h3 {
 margin-bottom: 0.8rem;
 color: var(--primary);
 font-size: 1.2rem;
 }

 .history-items {
 display: grid;
 grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
 gap: 0.8rem;
 }

 .history-item {
 border-radius: 7px;
 background: var(--dark);
 padding: 0.8rem;
 cursor: pointer;
 transition: all 0.3s ease;
 position: relative;
 }

 .history-item:hover {
 transform: translateY(-4px);
 box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4);
 }

 .history-item .prompt {
 font-size: 0.85rem;
 color: var(--text);
 margin-bottom: 0.4rem;
 display: -webkit-box;
 -webkit-line-clamp: 2;
 -webkit-box-orient: vertical;
 overflow: hidden;
 }

 .history-item .response-count {
 font-size: 0.75rem;
 color: var(--text-muted);
 }

 .history-delete-btn {
 position: absolute;
 top: 4px;
 right: 4px;
 background: var(--danger);
 color: white;
 border: none;
 border-radius: 50%;
 width: 20px;
 height: 20px;
 font-size: 0.7rem;
 cursor: pointer;
 display: none;
 align-items: center;
 justify-content: center;
 transition: all 0.3s ease;
 }

 .history-item:hover .history-delete-btn {
 display: flex;
 }

 .history-delete-btn:hover {
 background: #dc2626;
 transform: scale(1.1);
 }

 footer {
 text-align: center;
 margin-top: 1.5rem;
 color: var(--text-muted);
 font-size: 0.85rem;
 }

 @media (max-width: 768px) {
 .controls {
 flex-direction: column;
 align-items: stretch;
 }

 .system-prompt-container {
 flex-direction: column;
 }

 .control-icons {
 justify-content: center;
 }
 }

 .toast {
 position: fixed;
 bottom: 15px;
 right: 15px;
 background: var(--dark);
 color: white;
 padding: 0.8rem 1.2rem;
 border-radius: 7px;
 box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
 transform: translateY(100px);
 opacity: 0;
 transition: all 0.3s ease;
 z-index: 3000;
 font-size: 0.9rem;
 }

 .toast.show {
 transform: translateY(0);
 opacity: 1;
 }

 .toast.success {
 background: var(--success);
 }

 .toast.error {
 background: var(--danger);
 }

 .toast.warning {
 background: var(--warning);
 }
 </style>
</head>
<body>
 <div class="container">
 <header>
 <h1>Générateur de texte IA</h1>
 </header>

 <div class="controls">
 <div class="control-icons">
 <i class="fas fa-plus control-icon" id="new-conversation" title="Nouvelle conversation"></i>
 <i class="fas fa-tools control-icon" id="settings" title="Paramètres"></i>
 </div>
 <div class="system-prompt-container">
 <textarea id="system-prompt" class="system-prompt" placeholder="Entrez le prompt système...">Tu es une IA utile et respectueuse.</textarea>
 </div>
 <i class="fas fa-times clear-conversation-icon" id="clear-conversation" title="Supprimer la conversation"></i>
 </div>

 <div class="text-preview">
 <div id="loading" class="loading" style="display: none;">
 <div class="spinner"></div>
 <p>Génération de votre réponse...</p>
 </div>

 <div id="placeholder" class="placeholder">
 <i class="fas fa-comment-dots"></i>
 <p>Votre conversation apparaîtra ici</p>
 </div>

 <div class="chat-container">
 <div id="chat-messages" class="chat-messages"></div>
 </div>

 <div class="chat-input-container">
 <textarea id="prompt" class="chat-input" placeholder="Tapez votre message..."></textarea>
 <button id="send-btn" class="btn btn-primary">
 <i class="fas fa-paper-plane"></i>
 </button>
 </div>
 </div>

 <div class="overlay" id="settings-overlay">
 <div class="overlay-content">
 <i class="fas fa-times close-overlay" id="close-overlay"></i>
 <h3>Paramètres</h3>
 <div class="form-group">
 <label for="system-prompt-select">Prompt système prédéfini</label>
 <select id="system-prompt-select" class="system-prompt-select">
 <option value="">Choisir un prompt prédéfini</option>
 <option value="Tu es une IA qui doit répondre seulement en français">En français seulement</option>
 <option value="Tu es une IA qui donne des réponses concises">Réponses concises</option>
 <option value="Tu es une IA avec un ton professionnel">Ton professionnel</option>
 <option value="Tu es une IA créative et imaginative">Réponses créatives</option>
 </select>
 </div>
 <div class="form-group">
 <label for="model">Modèle</label>
 <select id="model">
 <option value="" disabled selected>Chargement des modèles...</option>
 </select>
 </div>
 <div class="form-group">
 <label for="seed">Seed (optionnel)</label>
 <div class="input-container">
 <input type="text" id="seed" placeholder="Entrez une graine" pattern="[0-9]*">
 <i class="fas fa-times clear-icon" id="clear-seed"></i>
 </div>
 </div>
 <div class="form-group" id="reasoning-group">
 <label for="reasoning-effort">Effort de raisonnement</label>
 <select id="reasoning-effort">
 <option value="low">Faible</option>
 <option value="medium">Moyen</option>
 <option value="high">Haut</option>
 </select>
 </div>
 </div>
 </div>

 <div class="history">
 <div class="history-header">
 <h3>Historique des conversations</h3>
 <button id="clear-history-btn" class="btn btn-danger">
 <i class="fas fa-trash"></i> Effacer l'historique
 </button>
 </div>
 <div id="history-items" class="history-items">
 <!-- Les éléments de l'historique seront ajoutés ici -->
 </div>
 </div>

 <footer>
 <p>Propulsé par Elgabo ✨</p>
 </footer>
 </div>

 <div id="toast" class="toast"></div>

 <script>
 document.addEventListener('DOMContentLoaded', function() {
 // Variables d'état
 let isGenerating = false;
 let isWaiting = false;
 let currentPrompt = '';
 let availableModels = [];
 let currentText = '';
 let conversationHistory = [];
 let currentConversationId = null;
 let chunkBuffer = ''; // Buffer pour accumuler les chunks

 // Durée d'expiration du cache (24 heures)
 const CACHE_EXPIRY = 24 * 60 * 60 * 1000;

 // Liste de mots inappropriés
 const inappropriateWords = ['motherfucker', 'fuck', 'shit', 'bitch'];

 // Initialiser les champs
 const promptInput = document.getElementById('prompt');
 promptInput.value = '';
 const systemPromptInput = document.getElementById('system-prompt');
 const seedInput = document.getElementById('seed');
 seedInput.value = '';
 const reasoningGroup = document.getElementById('reasoning-group');
 reasoningGroup.classList.add('hidden');
 document.getElementById('reasoning-effort').value = 'low';

 // Ajuster dynamiquement la hauteur des textareas
 function adjustTextareaHeight(textarea) {
 textarea.style.height = 'auto';
 textarea.style.height = `${Math.min(textarea.scrollHeight, textarea.classList.contains('system-prompt') ? 70 : 100)}px`;
 }

 [promptInput, systemPromptInput].forEach(input => {
 input.addEventListener('input', () => adjustTextareaHeight(input));
 });

 // Gérer le menu des prompts système prédéfinis dans l'overlay
 const systemPromptSelect = document.getElementById('system-prompt-select');
 systemPromptSelect.addEventListener('change', () => {
 if (systemPromptSelect.value) {
 systemPromptInput.value = systemPromptSelect.value;
 adjustTextareaHeight(systemPromptInput);
 }
 systemPromptSelect.value = ''; // Réinitialiser la sélection
 });

 // Gérer la croix pour effacer le seed
 const clearSeedIcon = document.getElementById('clear-seed');
 clearSeedIcon.addEventListener('click', () => {
 seedInput.value = '';
 clearSeedIcon.classList.remove('visible');
 });
 seedInput.addEventListener('input', () => {
 clearSeedIcon.classList.toggle('visible', seedInput.value.length > 0);
 });

 // Gérer la croix pour effacer la conversation de l'historique
 const clearConversationIcon = document.getElementById('clear-conversation');
 clearConversationIcon.addEventListener('click', () => {
 if (currentConversationId && window.confirm('Voulez-vous supprimer cette conversation de l\'historique ?')) {
 let history = JSON.parse(localStorage.getItem('textHistory') || '[]');
 history = history.filter(h => h.id !== currentConversationId);
 localStorage.setItem('textHistory', JSON.stringify(history));
 clearConversation();
 loadHistory();
 showToast('Conversation supprimée de l\'historique !', 'success');
 clearConversationIcon.classList.remove('visible');
 }
 });

 // Gérer l'icône "+" pour nouvelle conversation
 const newConversationIcon = document.getElementById('new-conversation');
 newConversationIcon.addEventListener('click', () => {
 clearConversation();
 showToast('Nouvelle conversation démarrée !', 'success');
 });

 // Gérer l'overlay des paramètres
 const settingsIcon = document.getElementById('settings');
 const settingsOverlay = document.getElementById('settings-overlay');
 const closeOverlay = document.getElementById('close-overlay');
 settingsIcon.addEventListener('click', () => {
 settingsOverlay.classList.add('show');
 });
 closeOverlay.addEventListener('click', () => {
 settingsOverlay.classList.remove('show');
 });
 settingsOverlay.addEventListener('click', (e) => {
 if (e.target === settingsOverlay) {
 settingsOverlay.classList.remove('show');
 }
 });

 // Charger les modèles
 function loadModels() {
 const modelSelect = document.getElementById('model');
 const sendBtn = document.getElementById('send-btn');

 const cachedModels = JSON.parse(localStorage.getItem('modelCache') || '{}');
 const now = Date.now();

 if (cachedModels.models && cachedModels.timestamp && (now - cachedModels.timestamp < CACHE_EXPIRY)) {
 availableModels = cachedModels.models;
 updateModelSelect(availableModels);
 sendBtn.disabled = false;
 updateReasoningSelect(modelSelect.value);
 } else {
 fetchModels();
 }
 }

 async function fetchModels() {
 const modelSelect = document.getElementById('model');
 const sendBtn = document.getElementById('send-btn');

 try {
 const response = await fetch('https://text.pollinations.ai/models');
 if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
 const modelsData = await response.json();

 availableModels = modelsData
 .filter(model => model.output_modalities.includes('text') && !model.audio)
 .map(model => ({
 value: model.name,
 label: model.description || model.name
 }));

 if (availableModels.length === 0) throw new Error('Aucun modèle de texte disponible');

 localStorage.setItem('modelCache', JSON.stringify({
 models: availableModels,
 timestamp: Date.now()
 }));

 updateModelSelect(availableModels);
 sendBtn.disabled = false;
 updateReasoningSelect(modelSelect.value);
 } catch (error) {
 console.error('Erreur lors de la récupération des modèles:', error);
 const cachedModels = JSON.parse(localStorage.getItem('modelCache') || '{}');
 const now = Date.now();
 if (cachedModels.models && cachedModels.timestamp && (now - cachedModels.timestamp < CACHE_EXPIRY)) {
 availableModels = cachedModels.models;
 updateModelSelect(availableModels);
 sendBtn.disabled = false;
 updateReasoningSelect(modelSelect.value);
 showToast('Utilisation du cache local pour les modèles.', 'warning', 5000);
 } else {
 modelSelect.innerHTML = '<option value="" disabled selected>Erreur: Impossible de charger les modèles</option>';
 sendBtn.disabled = true;
 reasoningGroup.classList.add('hidden');
 showToast('Impossible de charger les modèles.', 'error', 5000);
 }
 }
 }

 function updateModelSelect(models) {
 const modelSelect = document.getElementById('model');
 modelSelect.innerHTML = '';
 models.forEach(model => {
 const option = document.createElement('option');
 option.value = model.value;
 option.textContent = model.label;
 if (model.value === 'openai-large') option.selected = true; // Sélectionner gpt-4.1-mini par défaut
 modelSelect.appendChild(option);
 });

 // Si gpt-4.1-mini n'est pas trouvé, sélectionner le premier modèle par défaut
 if (!models.some(model => model.value === 'openai-large')) {
 console.warn('Modèle gpt-4.1-mini non trouvé, sélection du premier modèle disponible.');
 if (models.length > 0) {
 modelSelect.value = models[0].value;
 }
 }

 modelSelect.addEventListener('change', () => {
 updateReasoningSelect(modelSelect.value);
 });
 }

 function updateReasoningSelect(model) {
 if (model === 'openai-reasoning') {
 reasoningGroup.classList.remove('hidden');
 } else {
 reasoningGroup.classList.add('hidden');
 }
 }

 loadModels();

 // Gérer l'interface de chat
 const chatMessages = document.getElementById('chat-messages');
 const sendBtn = document.getElementById('send-btn');

 function addMessage(role, content, regeneratePrompt = null) {
 const messageContainer = document.createElement('div');
 messageContainer.className = 'message-container';
 if (role === 'user') {
 messageContainer.dataset.prompt = content; // Pour modification
 } else if (role === 'assistant' && regeneratePrompt) {
 messageContainer.dataset.prompt = regeneratePrompt; // Pour régénération
 }

 const messageDiv = document.createElement('div');
 messageDiv.className = `message ${role}`;
 messageDiv.textContent = content;

 if (role === 'user') {
 // Ajouter l'icône de modification
 const editIcon = document.createElement('i');
 editIcon.className = 'fas fa-pencil-alt edit-icon';
 messageDiv.appendChild(editIcon);

 // Activer l'édition au clic sur le message
 messageDiv.addEventListener('click', (e) => {
 // Éviter d'activer l'édition si on clique sur la zone d'édition elle-même
 if (!e.target.closest('.edit-prompt-container')) {
 toggleEditPrompt(messageContainer);
 }
 });
 }

 messageContainer.appendChild(messageDiv);

 if (role === 'assistant') {
 const actionsDiv = document.createElement('div');
 actionsDiv.className = 'message-actions ai';

 const regenerateBtn = document.createElement('button');
 regenerateBtn.className = 'regenerate-btn';
 regenerateBtn.innerHTML = '<i class="fas fa-redo"></i> Régénérer';
 regenerateBtn.addEventListener('click', () => regenerateResponse(messageContainer));

 actionsDiv.appendChild(regenerateBtn);
 messageContainer.appendChild(actionsDiv);
 }

 // Ajouter la zone d'édition pour les messages utilisateur
 if (role === 'user') {
 const editContainer = document.createElement('div');
 editContainer.className = 'edit-prompt-container';
 const editTextarea = document.createElement('textarea');
 editTextarea.value = content;
 editTextarea.addEventListener('input', () => adjustTextareaHeight(editTextarea));
 editTextarea.addEventListener('keypress', (e) => {
 if (e.key === 'Enter' && !e.shiftKey) {
 e.preventDefault();
 saveEditedPrompt(messageContainer, editTextarea.value);
 }
 });
 const saveBtn = document.createElement('button');
 saveBtn.className = 'save-btn';
 saveBtn.textContent = 'Enregistrer';
 saveBtn.addEventListener('click', () => saveEditedPrompt(messageContainer, editTextarea.value));

 editContainer.appendChild(editTextarea);
 editContainer.appendChild(saveBtn);
 messageContainer.appendChild(editContainer);
 }

 chatMessages.appendChild(messageContainer);
 chatMessages.scrollTop = chatMessages.scrollHeight;
 clearConversationIcon.classList.add('visible');
 }

 function toggleEditPrompt(messageContainer) {
 const editContainer = messageContainer.querySelector('.edit-prompt-container');
 editContainer.classList.toggle('active');
 if (editContainer.classList.contains('active')) {
 const textarea = editContainer.querySelector('textarea');
 adjustTextareaHeight(textarea);
 textarea.focus();
 }
 }

 async function regenerateResponse(messageContainer) {
 if (isGenerating || isWaiting) {
 showToast('Une génération est en cours. Veuillez attendre.', 'error');
 return;
 }

 const index = Array.from(chatMessages.children).indexOf(messageContainer);
 if (index === -1 || conversationHistory[index].role !== 'assistant') return;

 const userIndex = index - 1;
 const userPrompt = conversationHistory[userIndex].content;

 // Supprimer tous les messages à partir de la réponse IA
 conversationHistory = conversationHistory.slice(0, index);
 while (chatMessages.children.length > userIndex + 1) {
 chatMessages.removeChild(chatMessages.lastChild);
 }

 // Régénérer sans seed et avec un horodatage unique pour plus de variabilité
 const originalSeed = seedInput.value;
 seedInput.value = ''; // Temporairement vider le seed
 await generateText(userPrompt, true); // Passer un flag pour régénération
 seedInput.value = originalSeed; // Restaurer le seed
 }

 async function saveEditedPrompt(messageContainer, newPrompt) {
 if (isGenerating || isWaiting) {
 showToast('Une génération est en cours. Veuillez attendre.', 'error');
 return;
 }

 const index = Array.from(chatMessages.children).indexOf(messageContainer);
 if (index === -1 || conversationHistory[index].role !== 'user') return;

 if (!newPrompt.trim()) {
 showToast('Le prompt ne peut pas être vide.', 'error');
 return;
 }

 // Mettre à jour le prompt utilisateur
 conversationHistory[index].content = newPrompt;
 const messageDiv = messageContainer.querySelector('.message');
 messageDiv.textContent = newPrompt;
 // Recréer l'icône d'édition pour s'assurer qu'elle reste présente
 const editIcon = document.createElement('i');
 editIcon.className = 'fas fa-pencil-alt edit-icon';
 messageDiv.appendChild(editIcon);
 messageContainer.dataset.prompt = newPrompt;

 // Supprimer tous les messages suivants
 conversationHistory.splice(index + 1);
 while (chatMessages.children.length > index + 1) {
 chatMessages.removeChild(chatMessages.children[index + 1]);
 }

 // Désactiver le mode édition
 const editContainer = messageContainer.querySelector('.edit-prompt-container');
 editContainer.classList.remove('active');

 // Régénérer
 await generateText(newPrompt);
 }

 function filterContent(content) {
 let filtered = content;
 inappropriateWords.forEach(word => {
 const regex = new RegExp(`\\b${word}\\b`, 'gi');
 filtered = filtered.replace(regex, '***');
 });
 return filtered;
 }

 function clearConversation() {
 conversationHistory = [];
 currentConversationId = null;
 chatMessages.innerHTML = '';
 document.getElementById('placeholder').style.display = 'flex';
 clearConversationIcon.classList.remove('visible');
 promptInput.value = '';
 adjustTextareaHeight(promptInput);
 currentText = '';
 currentPrompt = '';
 // Ne pas réinitialiser systemPromptInput
 }

 sendBtn.addEventListener('click', () => generateText(promptInput.value));
 promptInput.addEventListener('keypress', (e) => {
 if (e.key === 'Enter' && !e.shiftKey) {
 e.preventDefault();
 generateText(promptInput.value);
 }
 });

 // Historique
 const clearHistoryBtn = document.getElementById('clear-history-btn');
 clearHistoryBtn.addEventListener('click', () => {
 if (window.confirm('Voulez-vous vraiment effacer tout l\'historique des conversations ?')) {
 clearHistory();
 }
 });

 function generateFileName(prompt) {
 let cleanPrompt = prompt
 .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
 .replace(/[^a-zA-Z0-9\s-]/g, '')
 .trim()
 .replace(/\s+/g, '-')
 .toLowerCase();
 if (cleanPrompt.length > 50) {
 cleanPrompt = cleanPrompt.substring(0, 50);
 cleanPrompt = cleanPrompt.substring(0, cleanPrompt.lastIndexOf('-') + 1) || cleanPrompt;
 }
 return cleanPrompt ? `${cleanPrompt}.txt` : 'conversation-ia.txt';
 }

 function loadHistory() {
 const history = JSON.parse(localStorage.getItem('textHistory') || '[]');
 const historyContainer = document.getElementById('history-items');
 const historySection = document.querySelector('.history');

 historyContainer.innerHTML = '';

 if (history.length === 0) {
 historySection.classList.remove('show');
 return;
 }

 historySection.classList.add('show');

 history.forEach(item => {
 const historyItem = document.createElement('div');
 historyItem.className = 'history-item';
 const firstPrompt = item.messages.find(msg => msg.role === 'user')?.content || 'Conversation';
 const responseCount = item.messages.filter(msg => msg.role === 'assistant').length;
 historyItem.innerHTML = `
 <div class="prompt">${firstPrompt}</div>
 <div class="response-count">Réponses: ${responseCount}</div>
 <button class="history-delete-btn"><i class="fas fa-times"></i></button>
 `;

 const deleteBtn = historyItem.querySelector('.history-delete-btn');
 deleteBtn.addEventListener('click', (e) => {
 e.stopPropagation();
 if (window.confirm('Voulez-vous supprimer cette conversation de l\'historique ?')) {
 let history = JSON.parse(localStorage.getItem('textHistory') || '[]');
 history = history.filter(h => h.id !== item.id);
 localStorage.setItem('textHistory', JSON.stringify(history));
 if (currentConversationId === item.id) clearConversation();
 loadHistory();
 showToast('Conversation supprimée !', 'success');
 }
 });

 historyItem.addEventListener('click', () => {
 conversationHistory = item.messages;
 currentConversationId = item.id;
 chatMessages.innerHTML = '';
 conversationHistory.forEach((msg, index) => {
 const prevMsg = index > 0 ? conversationHistory[index - 1] : null;
 const regeneratePrompt = msg.role === 'assistant' && prevMsg && prevMsg.role === 'user' ? prevMsg.content : null;
 addMessage(msg.role, filterContent(msg.content), regeneratePrompt);
 });
 document.getElementById('placeholder').style.display = 'none';
 clearConversationIcon.classList.add('visible');
 // Restaurer le dernier modèle utilisé
 const modelSelect = document.getElementById('model');
 if (item.model && availableModels.some(m => m.value === item.model)) {
 modelSelect.value = item.model;
 } else {
 modelSelect.value = 'gpt-4.1-mini'; // Valeur par défaut si le modèle n'est pas disponible
 }
 document.getElementById('seed').value = item.seed || '';
 document.getElementById('reasoning-effort').value = item.reasoning_effort || 'low';
 updateReasoningSelect(modelSelect.value);
 systemPromptInput.value = item.systemPrompt || 'Tu es une IA utile et respectueuse.';
 adjustTextareaHeight(systemPromptInput);
 currentPrompt = firstPrompt;
 currentText = conversationHistory.find(msg => msg.role === 'assistant')?.content || '';
 });

 historyContainer.appendChild(historyItem);
 });
 }

 function clearHistory() {
 localStorage.removeItem('textHistory');
 clearConversation();
 systemPromptInput.value = 'Tu es une IA utile et respectueuse.';
 adjustTextareaHeight(systemPromptInput);
 loadHistory();
 }

 function showToast(message, type = '', duration = 3000) {
 const toast = document.getElementById('toast');
 toast.textContent = message;
 toast.className = 'toast';
 if (type) toast.classList.add(type);
 toast.classList.add('show');

 setTimeout(() => {
 toast.classList.remove('show');
 }, duration);
 }

 function startCooldown() {
 isWaiting = true;
 let timeLeft = 3;
 sendBtn.disabled = true;
 const originalText = sendBtn.innerHTML;

 const countdown = setInterval(() => {
 sendBtn.innerHTML = `<i class="fas fa-paper-plane"></i> (${timeLeft}s)`;
 timeLeft--;
 if (timeLeft < 0) {
 clearInterval(countdown);
 sendBtn.innerHTML = originalText;
 sendBtn.disabled = false;
 isWaiting = false;
 }
 }, 1000);
 }

 async function generateText(prompt, isRegenerate = false) {
 if (isWaiting) {
 showToast('Veuillez attendre avant de générer une nouvelle réponse.', 'error');
 return;
 }

 if (!prompt.trim()) {
 showToast('Veuillez entrer un message.', 'error');
 return;
 }

 const systemPrompt = systemPromptInput.value.trim();
 if (!systemPrompt) {
 showToast('Veuillez entrer un prompt système.', 'error');
 return;
 }

 const model = document.getElementById('model').value;
 if (!model || !availableModels.some(m => m.value === model)) {
 showToast('Veuillez sélectionner un modèle valide.', 'error');
 return;
 }

 const seed = seedInput.value.trim();
 const reasoningEffort = model === 'openai-reasoning' ? document.getElementById('reasoning-effort').value : undefined;

 if (seed && !/^\d+$/.test(seed)) {
 showToast('Le seed doit être un nombre entier positif.', 'error');
 return;
 }

 currentPrompt = currentPrompt || prompt;
 isGenerating = true;

 document.getElementById('loading').style.display = 'flex';
 document.getElementById('placeholder').style.display = 'none';

 if (!conversationHistory.some(msg => msg.role === 'user' && msg.content === prompt)) {
 conversationHistory.push({ role: 'user', content: prompt });
 addMessage('user', prompt);
 }
 promptInput.value = '';
 adjustTextareaHeight(promptInput);

 try {
 const requestBody = {
 model: model,
 messages: [
 { role: 'system', content: systemPrompt },
 ...conversationHistory
 ],
 stream: true,
 seed: isRegenerate ? undefined : (seed ? parseInt(seed) : undefined), // Pas de seed pour régénération
 private: true
 };
 if (model === 'openai-reasoning') {
 requestBody.reasoning_effort = reasoningEffort;
 }
 if (isRegenerate) {
 // Ajouter un horodatage unique pour forcer une nouvelle réponse
 requestBody.regenerate_timestamp = Date.now();
 }

 console.log('Requête envoyée:', JSON.stringify(requestBody));

 const response = await fetch('https://text.pollinations.ai/', {
 method: 'POST',
 headers: {
 'Content-Type': 'application/json'
 },
 body: JSON.stringify(requestBody)
 });

 if (!response.ok) {
 const errorText = await response.text();
 console.error('Erreur API:', errorText);
 throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
 }

 const reader = response.body.getReader();
 let aiMessage = '';
 const messageDiv = document.createElement('div');
 messageDiv.className = 'message ai';
 const messageContainer = document.createElement('div');
 messageContainer.className = 'message-container';
 messageContainer.dataset.prompt = prompt;
 messageContainer.appendChild(messageDiv);

 const actionsDiv = document.createElement('div');
 actionsDiv.className = 'message-actions ai';
 const regenerateBtn = document.createElement('button');
 regenerateBtn.className = 'regenerate-btn';
 regenerateBtn.innerHTML = '<i class="fas fa-redo"></i> Régénérer';
 regenerateBtn.addEventListener('click', () => regenerateResponse(messageContainer));
 actionsDiv.appendChild(regenerateBtn);
 messageContainer.appendChild(actionsDiv);

 chatMessages.appendChild(messageContainer);

 chunkBuffer = ''; // Réinitialiser le buffer

 while (true) {
 const { done, value } = await reader.read();
 if (done) break;

 const chunk = new TextDecoder().decode(value);
 console.log('Chunk reçu:', chunk);
 chunkBuffer += chunk;

 const lines = chunkBuffer.split('\n');
 chunkBuffer = lines.pop();

 for (const line of lines) {
 if (line.startsWith('data: ')) {
 const data = line.slice(6);
 if (data === '[DONE]') break;
 try {
 const parsed = JSON.parse(data);
 if (parsed.choices && parsed.choices.length > 0 && parsed.choices[0].delta && parsed.choices[0].delta.content) {
 const content = parsed.choices[0].delta.content;
 aiMessage += content;
 messageDiv.textContent = filterContent(aiMessage);
 chatMessages.scrollTop = chatMessages.scrollHeight;
 clearConversationIcon.classList.add('visible');
 }
 if (parsed.choices && parsed.choices[0] && parsed.choices[0].finish_reason) {
 break;
 }
 } catch (e) {
 console.error('Erreur lors du parsing du chunk:', e, 'Données:', data);
 continue;
 }
 }
 }
 }

 if (!aiMessage) {
 throw new Error('Aucune réponse valide reçue de l\'API');
 }

 currentText = aiMessage;
 conversationHistory.push({ role: 'assistant', content: aiMessage });

 document.getElementById('loading').style.display = 'none';

 updateHistory(model, seed, reasoningEffort, systemPrompt, conversationHistory);

 showToast('Réponse générée avec succès !', 'success');
 startCooldown();
 } catch (error) {
 console.error('Erreur:', error);
 document.getElementById('loading').style.display = 'none';
 document.getElementById('placeholder').style.display = conversationHistory.length === 0 ? 'flex' : 'none';
 showToast(`Erreur: ${error.message}`, 'error', 5000);
 startCooldown();
 } finally {
 isGenerating = false;
 chunkBuffer = '';
 }
 }

 function updateHistory(model, seed, reasoningEffort, systemPrompt, messages) {
 let history = JSON.parse(localStorage.getItem('textHistory') || '[]');
 if (!currentConversationId) {
 currentConversationId = Date.now().toString() + Math.random().toString(36).slice(2);
 history.unshift({
 id: currentConversationId,
 model: model,
 seed: seed,
 reasoning_effort: reasoningEffort,
 systemPrompt: systemPrompt,
 messages: messages,
 timestamp: new Date().toISOString()
 });
 } else {
 const index = history.findIndex(h => h.id === currentConversationId);
 if (index !== -1) {
 history[index] = {
 id: currentConversationId,
 model: model,
 seed: seed,
 reasoning_effort: reasoningEffort,
 systemPrompt: systemPrompt,
 messages: messages,
 timestamp: new Date().toISOString()
 };
 }
 }
 if (history.length > 10) {
 history = history.slice(0, 10);
 }
 localStorage.setItem('textHistory', JSON.stringify(history));
 loadHistory();
 }

 loadHistory();
 });
 </script>
</body>
</html>
