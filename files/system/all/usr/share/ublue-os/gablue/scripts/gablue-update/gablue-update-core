#!/usr/bin/bash

# Script de mise à jour de Gablue - Version Core
# Ce script effectue les mises à jour du système et communique avec la GUI

set -e

# Fonction pour envoyer les logs à la GUI
log_info() {
    echo "[INFO] $1"
}

log_warn() {
    echo "[WARN] $1"
}

log_error() {
    echo "[ERROR] $1"
}

log_success() {
    echo "[SUCCESS] $1"
}

# Fonction pour afficher la progression
update_progress() {
    local percent=$1
    local message=$2
    echo "Progress: ${percent}% - ${message}"
}

# Vérifier les arguments
AUTO_MODE=false
SKIP_REBOOT=false

for arg in "$@"; do
    case $arg in
        --auto)
            AUTO_MODE=true
            ;;
        --skip-reboot)
            SKIP_REBOOT=true
            ;;
        --help|-h)
            echo "Usage: gablue-update-core [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --auto         Mode automatique non-interactif"
            echo "  --skip-reboot  Ne pas proposer de redémarrage"
            echo "  --help, -h     Afficher cette aide"
            exit 0
            ;;
    esac
done

log_info "Démarrage de la mise à jour de Gablue"

# =============================================================================
# ÉTAPE 1: Annulation des mises à jour en attente
# =============================================================================

update_progress 5 "Annulation des mises à jour en attente..."
log_info "Annulation des mises à jour rpm-ostree en cours..."

if rpm-ostree cancel 2>/dev/null; then
    log_info "Mises à jour annulées avec succès"
else
    log_warn "Aucune mise à jour à annuler ou erreur lors de l'annulation"
fi

sleep 1

# =============================================================================
# ÉTAPE 2: Mise à jour du système via rpm-ostree
# =============================================================================

update_progress 10 "Mise à jour du système via rpm-ostree..."
log_info "Démarrage de la mise à jour rpm-ostree..."

# Variables pour suivre la progression
CURRENT_PHASE=""
LAST_PERCENT=0

# Fichier temporaire pour stocker l'état (car le while dans un pipe crée un sous-shell)
RPMOSTREE_STATUS_FILE=$(mktemp)
echo "NO_UPGRADE" > "$RPMOSTREE_STATUS_FILE"

# Capture de la sortie pour la progression avec parsing avancé
rpm-ostree upgrade 2>&1 | while read -r line; do
    echo "$line"

    # Détection si une vraie mise à jour a été effectuée
    if [[ "$line" =~ (Receiving|Writing|Scanning).*objects.*% ]]; then
        echo "UPGRADE_DONE" > "$RPMOSTREE_STATUS_FILE"
    fi

    # Détection des phases et pourcentages réels
    if [[ "$line" =~ Receiving[[:space:]]objects:[[:space:]]*([0-9]+)% ]]; then
        # Phase de téléchargement avec pourcentage réel (0-40% global)
        local_percent="${BASH_REMATCH[1]}"
        # Mapper 0-100% du téléchargement vers 10-50% global
        global_percent=$((10 + (local_percent * 40 / 100)))
        if [ "$global_percent" -ne "$LAST_PERCENT" ]; then
            update_progress "$global_percent" "Téléchargement : ${local_percent}%"
            LAST_PERCENT=$global_percent
        fi

    elif [[ "$line" =~ Writing[[:space:]]objects:[[:space:]]*([0-9]+)% ]]; then
        # Phase d'écriture avec pourcentage réel (50-80% global)
        local_percent="${BASH_REMATCH[1]}"
        # Mapper 0-100% de l'écriture vers 50-80% global
        global_percent=$((50 + (local_percent * 30 / 100)))
        if [ "$global_percent" -ne "$LAST_PERCENT" ]; then
            update_progress "$global_percent" "Installation : ${local_percent}%"
            LAST_PERCENT=$global_percent
        fi

    elif [[ "$line" =~ Scanning[[:space:]]*([0-9]+)% ]]; then
        # Phase de scan
        local_percent="${BASH_REMATCH[1]}"
        global_percent=$((80 + (local_percent * 10 / 100)))
        if [ "$global_percent" -ne "$LAST_PERCENT" ]; then
            update_progress "$global_percent" "Analyse du système : ${local_percent}%"
            LAST_PERCENT=$global_percent
        fi

    elif [[ "$line" == *"Complete"* ]] || [[ "$line" == *"Successfully"* ]]; then
        update_progress 90 "Mise à jour système terminée"
        LAST_PERCENT=90
    fi
done

# Vérifier le résultat
rpm_ostree_exit_code=${PIPESTATUS[0]}
RPMOSTREE_UPGRADE_DONE=$(cat "$RPMOSTREE_STATUS_FILE")
rm -f "$RPMOSTREE_STATUS_FILE"

if [ "$rpm_ostree_exit_code" -ne 0 ]; then
    log_error "Échec de la mise à jour rpm-ostree (exit code: $rpm_ostree_exit_code)"
    exit 1
fi

if [ "$RPMOSTREE_UPGRADE_DONE" = "UPGRADE_DONE" ]; then
    log_success "Mise à jour rpm-ostree réussie"
else
    log_info "Aucune mise à jour rpm-ostree disponible"
fi

sleep 1

# =============================================================================
# ÉTAPE 3: Mise à jour des Flatpaks
# =============================================================================

update_progress 85 "Mise à jour des Flatpaks..."
log_info "Démarrage de la mise à jour des Flatpaks..."

# Fichier temporaire pour stocker l'état des flatpaks
FLATPAK_STATUS_FILE=$(mktemp)
echo "NO_UPDATES" > "$FLATPAK_STATUS_FILE"

flatpak update -y 2>&1 | while read -r line; do
    echo "$line"
    # Détection si des flatpaks ont été mis à jour
    if [[ "$line" =~ (Updating|Installing) ]]; then
        echo "UPDATES_DONE" > "$FLATPAK_STATUS_FILE"
        update_progress 90 "Mise à jour des applications Flatpak..."
    fi
done

# Vérifier le résultat
flatpak_exit_code=${PIPESTATUS[0]}
FLATPAK_UPDATES_DONE=$(cat "$FLATPAK_STATUS_FILE")
rm -f "$FLATPAK_STATUS_FILE"

if [ "$flatpak_exit_code" -ne 0 ]; then
    log_warn "Certaines mises à jour Flatpak ont échoué (non bloquant)"
else
    if [ "$FLATPAK_UPDATES_DONE" = "UPDATES_DONE" ]; then
        log_success "Mise à jour des Flatpaks réussie"
    else
        log_info "Aucune mise à jour Flatpak disponible"
    fi
fi

sleep 1

# =============================================================================
# ÉTAPE 4: Finalisation
# =============================================================================

# Déterminer le message final en fonction de ce qui a été fait
if [ "$RPMOSTREE_UPGRADE_DONE" != "UPGRADE_DONE" ] && [ "$FLATPAK_UPDATES_DONE" != "UPDATES_DONE" ]; then
    # Envoyer le signal d'abord pour que la GUI change d'état avant le log [SUCCESS]
    echo "__NO_UPDATES__"
    update_progress 100 "Système déjà à jour !"
    log_success "Le système est déjà à jour - aucune mise à jour nécessaire"
else
    update_progress 100 "Mise à jour terminée avec succès !"
    log_success "Toutes les mises à jour ont été effectuées avec succès"
fi

# =============================================================================
# Redémarrage (si demandé et non --skip-reboot)
# =============================================================================

if [ "$SKIP_REBOOT" = false ] && [ "$AUTO_MODE" = false ]; then
    log_info "Un redémarrage est nécessaire pour appliquer les changements système"
fi

exit 0
