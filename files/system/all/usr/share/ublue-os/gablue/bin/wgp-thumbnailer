#!/bin/bash
INPUT="$1"    # %i
OUTPUT="$2"   # %o
SIZE="$3"     # %s (128 ou 256)

[ -z "$SIZE" ] && SIZE=256

TEMP_MOUNT=$(mktemp -d)
TEMP_ICO=$(mktemp -d)

# Nettoyage complet en toute circonstance
trap 'fusermount -u "$TEMP_MOUNT" 2>/dev/null; rm -rf "$TEMP_MOUNT" "$TEMP_ICO"' EXIT

# Montage
squashfuse "$INPUT" "$TEMP_MOUNT" || exit 1

# L'icône custom .icon.png a priorité sur l'extraction depuis .exe
if [ -f "$TEMP_MOUNT/.icon.png" ]; then
    magick "$TEMP_MOUNT/.icon.png" -resize "${SIZE}x${SIZE}!" -background none -gravity center -extent "${SIZE}x${SIZE}" "$OUTPUT" 2>/dev/null && exit 0
fi

# Lecture .launch
if [ ! -f "$TEMP_MOUNT/.launch" ]; then
    exit 1  # → fallback MIME (org.gnome.Games)
fi

EXE_IN_WGP=$(cat "$TEMP_MOUNT/.launch" | tr -d '\r' | xargs)
ICON_EXE_PATH="$TEMP_MOUNT/$EXE_IN_WGP"

# Si le fichier indiqué est un symlink → suivre le lien pour trouver le vrai exe
if [ -L "$ICON_EXE_PATH" ]; then
    TARGET=$(readlink "$ICON_EXE_PATH")

    # Cas 1: Le symlink pointe vers /tmp/wgpackmount/ (WGP original, création)
    # Ex: /tmp/wgpackmount/Shadow Warrior Classic Redux/data/swcr.exe
    # Extraire: data/swcr.exe
    if [[ "$TARGET" == /tmp/wgpackmount/* ]]; then
        REL_PATH="${TARGET#/tmp/wgpackmount/*/}"
        ICON_EXE_PATH="$TEMP_MOUNT/$REL_PATH"
    # Cas 2: Le symlink pointe hors du WGP (chemin absolu après repack)
    # Ex: /home00/gab/Windows/Games/.../Game.exe
    # -> Le fichier n'existe pas dans le WGP monté, on ne peut pas extraire l'icône
    elif [[ "$TARGET" == /* ]]; then
        # Chemin absolu hors du WGP → pas d'icône possible
        exit 1
    fi
fi

# Si le fichier indiqué n'existe pas → fallback
[ -f "$ICON_EXE_PATH" ] || exit 1

# NOUVEAU : si c'est un .bat (ou .cmd, .ps1, etc.), on ne touche à rien → fallback
case "${ICON_EXE_PATH,,}" in  # ,, = tout en minuscule
    *.bat|*.cmd|*.ps1|*.vbs)
        exit 1  # → Dolphin affiche org.gnome.Games
        ;;
esac

# Sinon : c'est un .exe → extraction normale
wrestool -x -t14 "$ICON_EXE_PATH" -o "$TEMP_ICO" 2>/dev/null
if ls "$TEMP_ICO"/*.ico >/dev/null 2>&1; then
    icotool --extract --output="$TEMP_ICO" "$TEMP_ICO"/*.ico 2>/dev/null
fi

BIGGEST_PNG=$(ls -S "$TEMP_ICO"/*.png 2>/dev/null | head -n1)

if [ -n "$BIGGEST_PNG" ] && file "$BIGGEST_PNG" | grep -q "PNG image"; then
    magick "$BIGGEST_PNG" -resize "${SIZE}x${SIZE}!" -background none -gravity center -extent "${SIZE}x${SIZE}" "$OUTPUT"
else
    exit 1  # → fallback MIME si rien d'extrait
fi
