#!/bin/bash
INPUT="$1"    # %i
OUTPUT="$2"   # %o
SIZE="$3"     # %s (128 ou 256)

[ -z "$SIZE" ] && SIZE=256

TEMP_MOUNT=$(mktemp -d)
TEMP_ICO=$(mktemp -d)

# Nettoyage COMPLET quoi qu'il arrive (y compris en cas d'erreur ou exit prématuré)
trap 'fusermount -u "$TEMP_MOUNT" 2>/dev/null; rm -rf "$TEMP_MOUNT" "$TEMP_ICO"' EXIT

# Montage
squashfuse "$INPUT" "$TEMP_MOUNT" || exit 1

# Lecture .launch
[ -f "$TEMP_MOUNT/.launch" ] || exit 1
EXE_IN_WGP=$(cat "$TEMP_MOUNT/.launch" | tr -d '\r' | xargs)
ICON_EXE_PATH="$TEMP_MOUNT/$EXE_IN_WGP"
[ -f "$ICON_EXE_PATH" ] || exit 1

# Extraction
wrestool -x -t14 "$ICON_EXE_PATH" -o "$TEMP_ICO" 2>/dev/null
if ls "$TEMP_ICO"/*.ico >/dev/null 2>&1; then
    icotool --extract --output="$TEMP_ICO" "$TEMP_ICO"/*.ico 2>/dev/null
fi

# Meilleur PNG
BIGGEST_PNG=$(ls -S "$TEMP_ICO"/*.png 2>/dev/null | head -n1)

if [ -n "$BIGGEST_PNG" ] && file "$BIGGEST_PNG" | grep -q "PNG image"; then
    magick "$BIGGEST_PNG" -resize "${SIZE}x${SIZE}!" -background none -gravity center -extent "${SIZE}x${SIZE}" "$OUTPUT"
else
    magick -size "${SIZE}x${SIZE}" xc:none "$OUTPUT"
fi
