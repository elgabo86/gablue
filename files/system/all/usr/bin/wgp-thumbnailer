#!/bin/bash
INPUT="$1"
OUTPUT="$2"

TEMP_MOUNT=$(mktemp -d)
TEMP_ICO=$(mktemp -d)
trap 'fusermount -u "$TEMP_MOUNT" 2>/dev/null; rmdir "$TEMP_MOUNT"; rm -rf "$TEMP_ICO"' EXIT

squashfuse "$INPUT" "$TEMP_MOUNT" || exit 1

[ -f "$TEMP_MOUNT/.launch" ] || exit 1
EXE_IN_WGP=$(cat "$TEMP_MOUNT/.launch" | tr -d '\r' | xargs)
ICON_EXE_PATH="$TEMP_MOUNT/$EXE_IN_WGP"
[ -f "$ICON_EXE_PATH" ] || exit 1

# Extraction des groupes ICO
wrestool -x -t14 "$ICON_EXE_PATH" -o "$TEMP_ICO" 2>/dev/null

# Conversion de tous les .ico en PNG
if ls "$TEMP_ICO"/*.ico >/dev/null 2>&1; then
    icotool --extract --output="$TEMP_ICO" "$TEMP_ICO"/*.ico 2>/dev/null
fi

# Trouve le plus gros PNG valide, ou fallback
BIGGEST_PNG=$(ls -S "$TEMP_ICO"/*.png 2>/dev/null | head -n1)

if [ -n "$BIGGEST_PNG" ] && file "$BIGGEST_PNG" | grep -q "PNG image"; then
    magick "$BIGGEST_PNG" -resize 256x256! -background none -gravity center -extent 256x256 "$OUTPUT"
else
    # Fallback (utilise une icône générique qui étire bien si besoin)
    magick -size 256x256 xc:none "$OUTPUT"
fi
