#!/bin/bash

# Script pour télécharger et installer/mettre à jour ShadPS4Plus (Linux version) avec GearLever

# Dépendances : curl, jq, flatpak (GearLever installé comme it.mijorus.gearlever), unzip, yes

set -e

REPO="AzaharPlus/shadPS4Plus"
CACHE_DIR="$HOME/.cache/shadps4"
APPIMAGES_DIR="$HOME/AppImages"
mkdir -p "$CACHE_DIR"

# Vérifier si une version est déjà installée et la supprimer
INSTALLED_APPIMAGE=$(find "$APPIMAGES_DIR" -name "shadps4*.AppImage" | head -n1 || true)

if [ -n "$INSTALLED_APPIMAGE" ]; then
    echo "Suppression de la version installée existante."
    yes | flatpak run it.mijorus.gearlever --remove "$INSTALLED_APPIMAGE" 2>/dev/null || true
fi

# Obtenir les infos de la dernière release via GitHub API
RELEASE_JSON=$(curl -sL "https://api.github.com/repos/$REPO/releases/latest")

# Extraire l'URL de téléchargement pour l'archive Linux
ASSET_NAME_PATTERN="linux.zip"
DOWNLOAD_URL=$(echo "$RELEASE_JSON" | jq -r --arg pattern "$ASSET_NAME_PATTERN" '.assets[] | select(.name | contains($pattern)) | .browser_download_url')

if [ -z "$DOWNLOAD_URL" ]; then
    echo "Erreur : Archive Linux non trouvée dans la dernière release."
    exit 1
fi

# Extraire le nom du fichier
ASSET_NAME=$(basename "$DOWNLOAD_URL")

# Chemin du fichier à télécharger
NEW_ZIP_PATH="$CACHE_DIR/$ASSET_NAME"

# Télécharger l'archive ZIP
echo "Téléchargement de $ASSET_NAME..."
curl -L -o "$NEW_ZIP_PATH" "$DOWNLOAD_URL"

# Extraire l'archive et trouver l'AppImage
EXTRACT_DIR="$CACHE_DIR/extracted"
mkdir -p "$EXTRACT_DIR"
unzip -o "$NEW_ZIP_PATH" -d "$EXTRACT_DIR"

# Chercher spécifiquement l'AppImage shadps4plus.AppImage
APPIMAGE_FILE=$(find "$EXTRACT_DIR" -name "shadps4plus.AppImage" -type f | head -n1)

if [ -z "$APPIMAGE_FILE" ]; then
    echo "Erreur : shadps4plus.AppImage non trouvé dans l'archive."
    exit 1
fi

echo "AppImage trouvé : $(basename "$APPIMAGE_FILE")"

# Installer avec GearLever sans confirmation
echo "Installation/Mise à jour avec GearLever..."
yes | flatpak run it.mijorus.gearlever --integrate "$APPIMAGE_FILE"

# Corriger le .desktop pour enlever le (hash) et mettre la première lettre en majuscule
DESKTOP_DIR="$HOME/.local/share/applications"
DESKTOP_FILE=$(find "$DESKTOP_DIR" -name "shadps4*.desktop" -type f | head -n1)
if [ -n "$DESKTOP_FILE" ]; then
    sed -i 's/^Name=shadPS4 (.*)$/Name=ShadPS4/' "$DESKTOP_FILE"
    sed -i 's/^Name=shadPS4 (.*)$/Name=ShadPS4Plus/' "$DESKTOP_FILE"
    sed -i 's/^Name=shadps4plus (.*)$/Name=ShadPS4Plus/' "$DESKTOP_FILE"
    sed -i 's/^Name=shadps4plus$/Name=ShadPS4Plus/' "$DESKTOP_FILE"
    sed -i 's/^Name=shadps4$/Name=ShadPS4/' "$DESKTOP_FILE"
    sed -i '/^X-AppImage-Version=/d' "$DESKTOP_FILE"  # Optionnel: enlever la ligne version
fi

# Nettoyer le cache
rm -rf "$EXTRACT_DIR"
if [ -f "$NEW_ZIP_PATH" ]; then
    rm "$NEW_ZIP_PATH"
fi
rmdir --ignore-fail-on-non-empty "$CACHE_DIR"

# Rafraîchir les fichiers .desktop
kbuildsycoca6

echo "Opération terminée."