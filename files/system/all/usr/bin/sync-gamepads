#!/usr/bin/bash
#
# Wrapper pour sync-gamepads avec interface Pygame moderne
# Ce script lance l'interface graphique par défaut, avec fallback CLI
#

# Détection du mode
CLI_MODE=false

# Parser les arguments
for arg in "$@"; do
    case $arg in
        --cli|--nogui)
            CLI_MODE=true
            ;;
        --help|-h)
            echo "Usage: sync-gamepads [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --cli, --nogui Mode ligne de commande (sans interface graphique)"
            echo "  --help, -h     Afficher cette aide"
            echo ""
            echo "Par défaut, l'interface graphique Pygame est utilisée."
            echo ""
            echo "Ce script permet de connecter automatiquement vos manettes Bluetooth :"
            echo "  • DS4 (PlayStation 4)"
            echo "  • DualSense (PlayStation 5)"
            echo "  • Switch Pro Controller"
            echo "  • Joy-Con (Gauche et Droite)"
            echo "  • Wii U Pro Controller"
            exit 0
            ;;
    esac
done

# Détection du mode : développement (git repo) ou production
SCRIPT_DIR="/usr/share/ublue-os/gablue/scripts/sync-gamepads"

# Si on est dans le repo git (développement), utiliser les chemins relatifs
if [ -f "$(dirname "$0")/../share/ublue-os/gablue/scripts/sync-gamepads/sync-gamepads-gui.py" ]; then
    SCRIPT_DIR="$(dirname "$0")/../share/ublue-os/gablue/scripts/sync-gamepads"
fi

if [ "$CLI_MODE" = false ]; then
    # Vérifier si pygame est disponible
    if /usr/bin/python3 -c "import pygame" 2>/dev/null; then
        # Lancer l'interface graphique
        /usr/bin/python3 "$SCRIPT_DIR/sync-gamepads-gui.py"
        exit $?
    else
        echo "Pygame non disponible, utilisation du mode CLI"
        CLI_MODE=true
    fi
fi

# Mode ligne de commande (fallback)
if [ "$CLI_MODE" = true ]; then
    # Passer tous les arguments au script bash
    exec "$SCRIPT_DIR/sync-gamepads-core" "$@"
fi
